% !TeX root = Roboter.tex
\input{header_light_mode}
\usepackage{listings}
\definecolor{codebg}{rgb}{0.92,0.92,0.92}
\definecolor{keywordcolor}{rgb}{0.2,0.2,0.7}
\definecolor{stringcolor}{rgb}{0.8,0.1,0.1}
\definecolor{commentcolor}{rgb}{0.4,0.4,0.4}


\lstset{
  backgroundcolor=\color{codebg},
  %frame=single,
  %numbers=left,
  %numberstyle=\tiny\color{gray},
  basicstyle=\ttfamily\small,
  keywordstyle=\color{keywordcolor}\bfseries,
  stringstyle=\color{stringcolor},
  commentstyle=\color{gruen}\itshape,
  language=Python,
  tabsize=2,
  showstringspaces=false
}



\begin{document}

\begin{titlepage}

\newcommand{\TitleLineI}{Modellierung eines Roboters} 
\newcommand{\Author}{Nicolas Schäfer}
\newcommand{\SubmissionDate}{Saarbrücken, \today}

\thispagestyle{empty}



%\begin{center}
	%\includegraphics[scale=0.3]{cover.jpg}
%	\includegraphics[scale=0.3]{cover2.jpg}
%\end{center}


\rule{\textwidth}{0.4pt}

\begin{center}
	\begin{Large}
		Modellierung eines Roboters
	\end{Large}
\end{center}

\vspace{2.0cm}
\begin{center}
		\begin{tabular}{c}
			\Author \\
			 \SubmissionDate 
			%%Uncomment the following line for a third title line 
%			\TitleLineIII \\
		\end{tabular}
\end{center}
\vspace{1.5cm}

\end{titlepage}


\pagenumbering{roman}

\tableofcontents

\newpage

\pagenumbering{arabic}

\raggedbottom

\section{Modellierung eines Roboters}

% Herleitung der ELE aus Newton
\begin{align*}
    \underbrace{f - mg}_{\textsf{Kräftebilanz}} 
    = \underbrace{m \ddot{x}}_{\textsf{Newtons 2nd Law}} 
    &= \frac{\mathrm{d}}{\dt} \left[m \rot{\dot{x}} \right] \\
    f - \frac{\mathrm{\partial}}{\partial x} 
    \underbrace{
        \left[ mg x(t) \right]
        }_{\textsf{Potenzielle Energie }V} 
    &= \frac{\mathrm{d}}{\dt} \rot{\frac{\partial}{\partial \dot{x}}} 
    \underbrace{
        \left[m \rot{ \frac{1}{2} \dot{x}(t)^2} \right]
        }_{\textsf{kinetische Energie } T} \\
    f \dunkelgelb{- \frac{\partial V}{\partial x}} 
    = \frac{\mathrm{d}}{\dt} \rot{\frac{\partial T}{\partial \dot{x}}}
    &\Rightarrow
    f = \frac{\mathrm{d}}{\dt} \rot{\frac{\partial L}{\partial \dot{x}}} 
    - \dunkelgelb{\frac{\partial L}{\partial x}} 
\end{align*}

Wobei $L = T - V = \frac{1}{2}m \dot{x}(t)^2 -mg x(t)$ gilt.
Für generalisierte Koordinaten $\textbf{q} = \theta \in \mathbb{R}^n$
%
\begin{align*}
\frac{d}{dt} \left( \frac{\partial T}{\partial \dot{\textbf{q}}_{i}}  \right) 
- \frac{\partial T}{\partial \textbf{q}_i}  
+ \frac{\partial V}{\partial \textbf{q}_i} 
= \tau_i \quad i=1, \cdots , n
\end{align*}

% Herleitung kinetische Energie und Massenmatrix
Für die kinetische Energie eines starren Körpers gilt:
%
\begin{align*}
    T 
    &= \frac{1}{2} m \textbf{v}^T \textbf{v} 
    + \frac{1}{2} \boldsymbol{\omega}^T I \boldsymbol{\omega}
\end{align*}
%
Wobei $\textbf{v}$ die Geschwindigkeit des Schwerpunkts, 
$\boldsymbol{\omega}$ die Winkelgeschwindigkeit 
und $I$ der Trägheitstensor bezüglich des Schwerpunkts ist.
Für den Trägheitstensor gilt:
% Trägheitstensor Definition
\begin{align}
    I = \int_V \rho(\textbf{r}) 
    [(\textbf{r} \cdot \textbf{r}) \textbf{1} 
    - \textbf{r} \otimes \textbf{r}] \mathrm{d}V \label{eq:traegheitstensor}
\end{align}

Für ein Mehrkörpersystem mit generalisierten 
Koordinaten $\textbf{q}$ lässt sich die Gesamtenergie in 
kompakter Form schreiben als:
%
\begin{align*}
T &= \frac{1}{2} \dot{\textbf{q}}^T M(\textbf{q}) \dot{\textbf{q}}
\end{align*}
%
wobei $M(\textbf{q})$ die konfigurationsabhängige Massenmatrix ist, 
die alle Massen und Trägheiten der einzelnen Glieder erfasst.
Für die Geschwindigkeiten gilt mittels der Kettenregel:
% Definition Jacobi J_v, J_omega
\begin{align*}
    \textbf{v} = J_v(\textbf{q}) \dot{\textbf{q}} \quad \text{und} \quad
    \boldsymbol{\omega} = J_\omega(\textbf{q}) \dot{\textbf{q}}
    \quad
    J_v = \frac{\partial \textbf{x}}{\partial \textbf{q}} 
    \quad \text{und} \quad  
    J_\omega = \frac{\partial \boldsymbol{\omega}}{\partial \dot{\textbf{q}}}
\end{align*}

Einsetzen in die kinetische Energie liefert:
% Herleitung T = 1/2 q'M(q)q
\begin{align*}
    T 
    &= \frac{1}{2} m (J_v \dot{\textbf{q}})^T (J_v \dot{\textbf{q}}) 
    + \frac{1}{2} (J_\omega \dot{\textbf{q}})^T I (J_\omega \dot{\textbf{q}}) \\
    &= \frac{1}{2} \dot{\textbf{q}}^T (m J_v^T J_v) \dot{\textbf{q}} 
    + \frac{1}{2} \dot{\textbf{q}}^T (J_\omega^T I J_\omega) \dot{\textbf{q}} \\
    &= \frac{1}{2} \dot{\textbf{q}}^T 
    \underbrace{\left( m J_v^T J_v + J_\omega^T I J_\omega \right)}_{M(\textbf{q})} 
    \dot{\textbf{q}}
\end{align*}

Die Gesamtenergie setzt sich zusammen 
aus der Summe der Energien aller $n$ Glieder:
% Formulierung M(q)
\begin{align*}
    M(\textbf{q}) 
    &=
    \sum_{i=1}^n m_i J_{v_i}^T J_{v_i} + J_{\omega_i}^T I_i J_{\omega_i} 
\end{align*}

\subsection{Two Link Revolute Manipulator}

Wir bezeichnen $\textbf{q} = 
\begin{bmatrix} \gruen{\theta_1} \\ \dunkelrot{\theta_2} \end{bmatrix}$ 
als die generalisierten Koordinaten des Systems. Die Schwerpunkte der beiden Links
bezeichnen wir mit $(x_1, y_1)$ und $(x_2, y_2)$. Die Abstände der Schwerpunkte
von den Gelenken werden mit $a_1$ und $a_2$ bezeichnet.

% Graphik des Roboterarms
%--------------------------------------------------------------------------------------------------------
\begin{center}
\begin{tikzpicture}[scale = 1.75, every node/.style={transform shape}]
    % Koordinatensystem
    %\draw[very thin, gray] (-5,-5) grid (5,5); % Raster
    %\draw[->] (-5,0) -- (5,0); % x-Achse
    %\draw[->] (0,-5) -- (0,5); % y-Achse
    
    % Achsen und Hilfslinien
    \draw[white, dashed, ->] (0.0,-1.0) -- (3.5,-1.0);
    \draw[white, dashed, ->] (0.0,-1.0) -- (0.0,3.0);
    
    % Schwerpunkte
    \draw[dashed] (1.0,-0.5) -- (1.0,-1.0);
    \draw[dashed] (1.0,-0.5) -- (0,-0.5);
    \node at (-0.2, -0.5) {\tiny $y_1$};  % Punktbeschriftung
    \node at (1, -1.2) {\tiny $x_1$}; 
    \draw[dashed] (2.5,1) -- (0.0,1);
    \draw[dashed] (2.5,1) -- (2.5,-1);
    \node at (-0.2, 1.0) {\tiny $y_2$};  % Punktbeschriftung
    \node at (2.5, -1.2) {\tiny $x_2$}; 

    % Erste Zeichnung (Original)
    \fill[hellblau] (-4,-1) circle (0.25);  % Füllt das Objekt mit hellblau
    \draw[white, line width = 0.2mm] (-4,-1) circle (0.25);  % Weißer Rand um das Objekt
    
    \draw[white, line width = 0.2mm] (-4.25,-1.4) rectangle (-3.75,-1);  % Weißer Rand um das Rechteck
    \fill[hellblau] (-4.25,-1.4) rectangle (-3.75,-1);  % Füllt das Rechteck mit hellblau
    \draw[thick, white] (-4.5,-1.4) -- (-3.5,-1.4);
    
    % Grüne Linie angepasst (Endpunkt auf (-2.0, 0.0))
    \draw[thick, gruen] (-4,-1) -- (-2.0,0.0);
    
    % Rote Linie angepasst (von (-2.0, 0.0) nach (-1.0, 2.0))
    \draw[thick, dunkelrot] (-2.0,0.0) -- (-1.0,2.0);
    
    % Glieder
    \fill[blau] (-2.0,0.0) circle (0.1);
    \draw[white, thin] (-2.0,0.0) circle (0.1);  % Weißer Rand um das Objekt
    \fill[blau] (-4.0,-1.0) circle (0.1);
    \draw[white, thin] (-4.0,-1.0) circle (0.1);  % Weißer Rand um das Objekt
    
	% Beschriftungen
	\node at (-3, -0.75) {\tiny $\gruen{l_1}$};  % 
	\node at (-1.5, 1.5) {\tiny $\dunkelrot{l_2}$};  % 
	
	% Schwerpunkte 
	\fill[white] (-3.0,-0.5) circle (0.05);
	\fill[white] (-1.5,1) circle (0.05);
	
	\draw[white, <->] (-1.85,0.15) -- (-1.5,0.85);
	\draw[white, <->] (-3.85,-0.85) -- (-3.1,-0.45);
	
	% Beschriftungen
	\node at (-3.5, -0.4) {\tiny $a_1$};  % 
	\node at (-1.5, 0.5) {\tiny $a_2$};  % 
    
    % Zweite Zeichnung (verschoben um 4 Einheiten entlang der x-Achse)
    \fill[hellblau] (0,-1) circle (0.25);  % Füllt das Objekt mit hellblau
    \draw[white, line width = 0.2mm] (0,-1) circle (0.25);  % Weißer Rand um das Objekt
    
    \draw[white, line width = 0.2mm] (-0.25,-1.4) rectangle (0.25,-1);  % Weißer Rand um das Rechteck
    \fill[hellblau] (-0.25,-1.4) rectangle (0.25,-1);  % Füllt das Rechteck mit hellblau
    \draw[thick, white] (-0.5,-1.4) -- (0.5,-1.4);
    
    % Grüne Linie (verschoben)
    \draw[thick, gruen] (0,-1) -- (2.0,0.0);
    \draw[thick, gruen, dotted] (0,-1) -- (3.5,0.75);
    
    % Rote Linie (verschoben)
    \draw[thick, dunkelrot] (2.0,0.0) -- (3.0,2.0);
    
    % Glieder
    \fill[blau] (2.0,0.0) circle (0.1);
    \draw[white, thin] (2.0,0.0) circle (0.1);  % Weißer Rand um das Objekt
    \fill[blau] (0.0,-1.0) circle (0.1);
    \draw[white, thin] (0.0,-1.0) circle (0.1);  % Weißer Rand um das Objekt
    \fill[blau] (3.0,2.0) circle (0.1);
    \draw[white, thin] (3.0,2.0) circle (0.1);  % Weißer Rand um das Objekt
    
    % Winkel
    \draw [gruen, thick] (1,-1)  arc[start angle=0,end angle=45,radius=0.5cm];
	\node at (0.75, -0.85) {\tiny $\gruen{\theta_1}$};  % Winkelbeschriftung
	
	\draw [dunkelrot, thick] (3,0.5)  arc[start angle=0,end angle=80,radius=0.5cm];
	\node at (2.7, 0.6) {\tiny $\dunkelrot{\theta_2}$};  % Winkelbeschriftung
\end{tikzpicture}
\end{center}
%--------------------------------------------------------------------------------------------------------

Für die Koordinaten der Schwerpunkte gilt:
% Koordinaten der Schwerpunkte
\begin{align*}
    \begin{pmatrix}
        x_1 \\
        y_1 \\
        z_1
    \end{pmatrix}
    =
    \begin{pmatrix}
        a_1 \cdot \cos(\gruen{\theta_1}) \\
        a_1 \cdot \sin(\gruen{\theta_1}) \\
        0
    \end{pmatrix}
    \quad
    \begin{pmatrix}
        x_2 \\
        y_2 \\  
        z_2
    \end{pmatrix}
    =
    \begin{pmatrix}
        l_1 \cdot \cos(\gruen{\theta_1}) 
        + a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) \\
        l_1 \cdot \sin(\gruen{\theta_1}) 
        + a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) \\
        0
    \end{pmatrix}
\end{align*}

\subsubsection{Formulierung der Massenmatrix}

Für die Massenmatrix gilt hier:
% M(q)
\begin{align*}
    M(\textbf{q}) 
    = m_1 J_{v_{\gruen{1}}}^T J_{v_{\gruen{1}}} 
    + J_{\omega_{\gruen{1}}}^T I_1 J_{\omega_{\gruen{1}}}  
    + m_2 J_{v_{\dunkelrot{2}}}^T J_{v_{\dunkelrot{2}}} 
    + J_{\omega_{\dunkelrot{2}}}^T I_2 J_{\omega_{\dunkelrot{2}}} 
\end{align*}

Hierbei bezeichnet $J$ die Jacobi-Matrix, $I_i$ das Trägheitstensor 
und $m_i$ die Masse des $i$-ten Links.
% Berechnung der Jacobi-Matrizen J_v
\begin{align*}
    J_{v_1} &=
    \frac{\partial \textbf{r}_1}{\partial \textbf{q}}
    =
    \frac{\partial (x_1,y_1,z_1)}{\partial (\gruen{\theta_1}, \dunkelrot{\theta_2})}
    =
    \begin{pmatrix}
        \frac{\partial x_1}{\partial \gruen{\theta_1}} 
        & \frac{\partial x_1}{\partial \dunkelrot{\theta_2}} \\
        \frac{\partial y_1}{\partial \gruen{\theta_1}} 
        & \frac{\partial y_1}{\partial \dunkelrot{\theta_2}} \\
        \frac{\partial z_1}{\partial \gruen{\theta_1}} 
        & \frac{\partial z_1}{\partial \dunkelrot{\theta_2}} 
    \end{pmatrix}
    =
    \begin{pmatrix}
        -a_1 \sin(\gruen{\theta_1}) & 0 \\
        a_1 \cos(\gruen{\theta_1}) & 0 \\
        0 & 0
    \end{pmatrix}
    \\
    J_{v_2} &=
    \frac{\partial \textbf{r}_2}{\partial \textbf{q}}
    =
    \frac{\partial (x_2,y_2,z_2)}{\partial (\gruen{\theta_1}, \dunkelrot{\theta_2})}
    =
    \begin{pmatrix}
        \frac{\partial x_2}{\partial \gruen{\theta_1}} 
        & \frac{\partial x_2}{\partial \dunkelrot{\theta_2}} \\
        \frac{\partial y_2}{\partial \gruen{\theta_1}} 
        & \frac{\partial y_2}{\partial \dunkelrot{\theta_2}} \\
        \frac{\partial z_2}{\partial \gruen{\theta_1}}
        & \frac{\partial z_2}{\partial \dunkelrot{\theta_2}}
    \end{pmatrix} 
    =
    \begin{pmatrix}
        -l_1 \sin(\gruen{\theta_1}) - a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & -a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) \\
        l_1 \cos(\gruen{\theta_1}) + a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) \\
        0 & 0
    \end{pmatrix}
\end{align*}

Für das Matrizenprodukt $J_{v_1}^T J_{v_1}$ gilt:
% Berechnung der Matrizenprodukte J_v1^T * J_v1
\begin{align*}
    J_{v_1}^T J_{v_1} 
    &=
    \begin{pmatrix}
        -a_1 \sin(\gruen{\theta_1}) & a_1 \cos(\gruen{\theta_1}) & 0 \\
        0 & 0 & 0
    \end{pmatrix}
    \cdot
    \begin{pmatrix}
        -a_1 \sin(\gruen{\theta_1}) & 0 \\
        a_1 \cos(\gruen{\theta_1}) & 0 \\
        0 & 0
    \end{pmatrix}
    \\
    &=
    \begin{pmatrix}
        a_1^2 \sin^2(\gruen{\theta_1}) + a_1^2 \cos^2(\gruen{\theta_1}) & 0 \\
        0 & 0
    \end{pmatrix}
    \\
    &=
    \begin{pmatrix}
        a_1^2 & 0 \\
        0 & 0
    \end{pmatrix}
\end{align*}

Für das Matrizenprodukt $J_{v_2}^T J_{v_2}$ gilt:
% Berechnung der Matrizenprodukte J_v2^T * J_v2
\begin{align*}
    J_{v_2}^T J_{v_2} 
    &=
    \begin{pmatrix}
        -l_1 \sin(\gruen{\theta_1}) - a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & l_1 \cos(\gruen{\theta_1}) + a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & 0 \\
        -a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2})
        & 0
    \end{pmatrix}
    \\
    &\quad \cdot
    \begin{pmatrix}
        -l_1 \sin(\gruen{\theta_1}) - a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & -a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) \\
        l_1 \cos(\gruen{\theta_1}) + a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        & a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) \\
        0 & 0
    \end{pmatrix}
    \\
    &=
    \begin{pmatrix}
        (l_1^2 + a_2^2 + 2 l_1 a_2  \cos(\dunkelrot{\theta_{2}})) 
        & (a_2^2 + l_1 a_2  \cos(\dunkelrot{\theta_{2}})) \\
        (a_2^2 + l_1 a_2  \cos(\dunkelrot{\theta_{2}})) 
        & a_2^2
    \end{pmatrix}
\end{align*}

Für die Winkelgeschwindigkeiten setzen wir   
$\bm{\omega}_1 = \begin{pmatrix}0 & 0 & \gruen{\theta_1'}\end{pmatrix}^T$ und 
$\bm{\omega}_2 = \begin{pmatrix} 0 & 0 &\gruen{\theta_1'} + \dunkelrot{\theta_2'}\end{pmatrix}^T$.
% Berechnung der Jacobi-Matrizen J_\omega
\begin{align*}
    J_{\omega_1} &=
    \frac{\partial \bm{\omega}_1}{\partial \dot{\textbf{q}}}
    =
    \frac{\partial (\omega_1)}{\partial (\gruen{\theta_1}', \dunkelrot{\theta_2}')}
    =
    \begin{pmatrix}
        0 & 0 \\
        0 & 0 \\
        \frac{\partial \omega_1}{\partial \gruen{\theta_1}'} 
        & \frac{\partial \omega_1}{\partial \dunkelrot{\theta_2}'} 
    \end{pmatrix}
    =
    \begin{pmatrix}
        0 & 0 \\
        0 & 0 \\
        \gruen{1} & \dunkelrot{0}
    \end{pmatrix}
    \\
    J_{\omega_2} &=
    \frac{\partial \bm{\omega}_2}{\partial \dot{\textbf{q}}}
    =
    \frac{\partial (\omega_2)}{\partial (\gruen{\theta_1}', \dunkelrot{\theta_2}')}
    =
    \begin{pmatrix}
        0 & 0 \\
        0 & 0 \\
        \frac{\partial \omega_2}{\partial \gruen{\theta_1}'} 
        & \frac{\partial \omega_2}{\partial \dunkelrot{\theta_2}'} 
    \end{pmatrix}
    =
    \begin{pmatrix}
        0 & 0 \\
        0 & 0 \\
        \gruen{1} & \dunkelrot{1}
    \end{pmatrix}
\end{align*}

Für den Trägheitstensor $I_i$ gilt:
% Allgemeiner Trägheitstensor
\begin{align*}
    I = 
    \begin{pmatrix}
        I_{xx} & I_{xy} & I_{xz} \\
        I_{yx} & I_{yy} & I_{yz} \\
        I_{zx} & I_{zy} & I_{zz}
    \end{pmatrix}   
    =
    \begin{pmatrix}
        \int (y^2 + z^2) \mathrm{d}m & -\int xy \mathrm{d}m & -\int xz \mathrm{d}m \\
        -\int yx \mathrm{d}m & \int (x^2 + z^2) \mathrm{d}m & -\int yz \mathrm{d}m \\
        -\int zx \mathrm{d}m & -\int zy \mathrm{d}m & \int (x^2 + y^2) \mathrm{d}m
    \end{pmatrix}
\end{align*}

Für symmetrische Körper (z.B. Zylinder, Kugel, Quader) 
gilt: $I_{xy} = I_{xz} = I_{yz} = 0$ also erhalten wir eine Diagonalmatrix. 
% Symmetrischer Trägheitstensor
\begin{align*}
    I_i 
    =
    \begin{pmatrix}
        \int_ y^2 \mathrm{d}m & 0 & 0 \\
        0 & \int x^2 \mathrm{d}m & 0 \\
        0 & 0 & \int (x^2 + y^2) \mathrm{d}m
    \end{pmatrix}
    =
    \begin{pmatrix}
        \int_V \rho y^2 \mathrm{d}V & 0 & 0 \\
        0 & \int_V \rho x^2 \mathrm{d}V & 0 \\
        0 & 0 & \int_V \rho (x^2 + y^2) \mathrm{d}V
    \end{pmatrix}
\end{align*}


Für die Massenmatrix $M(\textbf{q})$ gilt somit:
% Berechnung der Massenmatrix M(q)
\begin{align*}
    M(\textbf{q}) 
    &= m_1 J_{v_{\gruen{1}}}^T J_{v_{\gruen{1}}} 
    + J_{\omega_{\gruen{1}}}^T I_1 J_{\omega_{\gruen{1}}}  
    + m_2 J_{v_{\dunkelrot{2}}}^T J_{v_{\dunkelrot{2}}} 
    + J_{\omega_{\dunkelrot{2}}}^T I_2 J_{\omega_{\dunkelrot{2}}}    
    \\
    &=
    m_1 
    \begin{pmatrix}
        a_1^2 & 0 \\
        0 & 0
    \end{pmatrix}
    +
    \underbrace{
        \begin{pmatrix}
            0 & 0 & \gruen{1} \\
            0 & 0 & \dunkelrot{0}
        \end{pmatrix}
        \cdot
        \begin{pmatrix}
            I_{1,xx} & 0 & 0 \\
            0 & I_{1,yy} & 0 \\
            0 & 0 & I_{1,zz}
        \end{pmatrix}}_{
        = 
        \begin{pmatrix}
            0 & 0 & I_{1,zz} \\
            0 & 0 & 0
        \end{pmatrix}
    }
    \cdot   
    \begin{pmatrix}
        0 & 0 \\
        0 & 0 \\
        \gruen{1} & \dunkelrot{0}
    \end{pmatrix}
    \\
    &\quad +
    m_2
    \begin{pmatrix}
        (l_1^2 + a_2^2 + 2 l_1 a_2  \cos(\dunkelrot{\theta_{2}})) 
        & (a_2^2 + l_1 a_2  \cos(\dunkelrot{\theta_{2}})) \\
        (a_2^2 + l_1 a_2  \cos(\dunkelrot{\theta_{2}})) 
        & a_2^2
    \end{pmatrix}
    \\
    &\quad +
    \underbrace{
        \begin{pmatrix}
            0 & 0 & \gruen{1} \\
            0 & 0 & \dunkelrot{1}
        \end{pmatrix}
        \cdot
        \begin{pmatrix}
            I_{2,xx} & 0 & 0 \\
            0 & I_{2,yy} & 0 \\
            0 & 0 & I_{2,zz}
        \end{pmatrix}}_{
        = 
        \begin{pmatrix}
            0 & 0 & I_{2,zz} \\
            0 & 0 & I_{2,zz}
        \end{pmatrix}
    }   
    \cdot
    \begin{pmatrix}
        0 & 0 \\
        0 & 0 \\
        \gruen{1} & \dunkelrot{1}
    \end{pmatrix}
    \\
    &=
    \begin{pmatrix}
        m_1 a_1^2 + I_{1,zz} + m_2 \cdot (l_1^2 + a_2^2 + 2 l_1 a_2  \cos(\dunkelrot{\theta_{2}})) + I_{2,zz}
        & m_2 (a_2^2 + l_1 a_2  \cos(\dunkelrot{\theta_{2}})) +I_{2,zz}  \\
        m_2 (a_2^2 + l_1 a_2  \cos(\dunkelrot{\theta_{2}})) + I_{2,zz}
        & m_2 a_2^2 +I_{2,zz} 
    \end{pmatrix}
\end{align*}

Die Trägheitselemente $I_{i,xx}$ und $I_{i,yy}$ sind nicht relevant.
Für unser Model verwenden wir den Standardansatz eines 
dünnen Stabes der Länge $l_i$ und Masse $m_i$. 
Somit gilt $z= y \approx 0$ und wir erhalten: $I_{i,xx} = I_{i,yy} =0$
% Tensor langer dünner Stab
\begin{align*}
    I_{i,zz} \approx \int_{-\frac{l_{i}}{2}}^{\frac{l_{i}}{2}} 
    \underbrace{\rho}_{\frac{m_{i}}{l_{i}}} x^2 \mathrm{d}x
    = \frac{1}{3} \cdot \frac{m_{i}}{l_{i}} 
    \cdot 
    \left[ 
        \left( \frac{l_{i}}{2} \right)^3 -  \left( -\frac{l_{i}}{2} \right)^3 
    \right]
    = \frac{1}{12} m_{i} l_{i}^{2}
    \Rightarrow
    I_i     
    = 
    \begin{pmatrix}
        0 & 0 & 0 \\
        0 & 0 & 0 \\
        0 & 0 & \frac{1}{12} m_{i} l_{i}^{2}
    \end{pmatrix}
\end{align*}


\subsubsection{Aufstellen der Coriolis-Matrix}

Für die partiellen Ableitungen der kinetischen Energie 
$T(\textbf{q}, \dot{\textbf{q}}) = \frac{1}{2} \dot{\textbf{q}}^T M(\textbf{q}) \dot{\textbf{q}}$ gilt:
% Ableitung dT/d theta
\begin{align*}
    \frac{\partial T}{\partial \gruen{\theta_{1}}}
    &= 
    \frac{1}{2}  \frac{\partial M_{11}}{\partial \gruen{\theta_{1}}} 
    \gruen{\theta_{1}'}^2 
    + \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} \gruen{\theta_{1}'} 
    \dunkelrot{\theta_{2}'} 
    + \frac{1}{2} \frac{\partial M_{22}}{\partial \gruen{\theta_{1}}} 
    \dunkelrot{\theta_{2}'}(t)^2
    \\
    \frac{\partial T}{\partial \dunkelrot{\theta_{2}}}
    &= 
    \frac{1}{2} \frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}} \gruen{\theta_{1}'}^2
    + \frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}} \gruen{\theta_{1}'} \dunkelrot{\theta_{2}'} 
    + \frac{1}{2} \frac{\partial M_{22}}{\partial \dunkelrot{\theta_{2}}} \dunkelrot{\theta_{2}'}(t)^2
    \\
    \frac{\partial T}{\partial \gruen{\theta_{1}'}} 
    &= M_{\gruen{1 1}} \gruen{\theta_{1}'} + M_{\gruen{1}\dunkelrot{2}}  \dunkelrot{\theta_{2}'}
    \\
    \frac{\partial T}{\partial \dunkelrot{\theta_{2}'}} 
    &=
    M_{\gruen{1}\dunkelrot{2}} \gruen{\theta_{1}'} + M_{\dunkelrot{22}} \dunkelrot{\theta_{2}'}
\end{align*}

Für die zeitlichen Ableitungen der Größen gilt 
% Ableitung d/dt dT/d theta_1'
\begin{align*}
\frac{\mathrm{d}}{\dt} \frac{\partial T}{\partial \gruen{\theta_{1}'}} 
&=
\underbrace{\frac{\mathrm{d}}{\dt} M_{\gruen{1 1}}}_{\frac{\partial M_{11}}{\partial \theta_{1}} \theta_{1}' + \frac{\partial M_{11}}{\partial \theta_{2}} \theta_{2}'} \cdot \gruen{\theta_{1}'} + M_{\gruen{1 1}} \gruen{\theta_{1}''} + \underbrace{\frac{\mathrm{d}}{\dt} M_{\gruen{1}\dunkelrot{2}}}_{\frac{\partial M_{12}}{\partial \theta_{1}} \theta_{1}' + \frac{\partial M_{12}}{\partial \theta_{2}} \theta_{2}'} \cdot \dunkelrot{\theta_{2}'} + M_{\gruen{1}\dunkelrot{2}} \dunkelrot{\theta_{2}''} 
\\
&= \frac{\partial M_{11}}{\partial \gruen{\theta_{1}}} \gruen{\theta_{1}'}^2
 + \frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}} \gruen{\theta_{1}'} \dunkelrot{ \theta_{2}'} 
 +  M_{\gruen{1 1}} \gruen{\theta_{1}''} 
 + \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} \gruen{\theta_{1}'} \dunkelrot{\theta_{2}'} 
 + \frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}} \dunkelrot{\theta_{2}'}^2 
 + M_{\gruen{1}\dunkelrot{2}} \dunkelrot{\theta_{2}''} \\
&=
\frac{\partial M_{11}}{\partial \gruen{\theta_{1}}} \gruen{\theta_{1}'}^2
 + \left[ \frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}} + \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} \right] \gruen{\theta_{1}'} \dunkelrot{ \theta_{2}'} 
 + \frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}} \dunkelrot{\theta_{2}'}^2 
 +  M_{\gruen{1 1}} \gruen{\theta_{1}''} 
    + M_{\gruen{1}\dunkelrot{2}} \dunkelrot{\theta_{2}''}
\end{align*}

% Ableitung d/dt dT/d theta_2'
\begin{align*}
\frac{\mathrm{d}}{\dt} \frac{\partial T}{\partial \dunkelrot{\theta_{2}'}} 
&=
\underbrace{\frac{\mathrm{d}}{\dt} M_{\gruen{1}\dunkelrot{2}}}_{\frac{\partial M_{12}}{\partial \theta_{1}} \theta_{1}' + \frac{\partial M_{12}}{\partial \theta_{2}} \theta_{2}'} \cdot \gruen{\theta_{1}'} + M_{\gruen{1}\dunkelrot{2}} \gruen{\theta_{1}''} + \underbrace{\frac{\mathrm{d}}{\dt} M_{\dunkelrot{22}}}_{\frac{\partial M_{22}}{\partial \theta_{1}} \theta_{1}' + \frac{\partial M_{22}}{\partial \theta_{2}} \theta_{2}'} \cdot \dunkelrot{\theta_{2}'} + M_{\dunkelrot{22}} \dunkelrot{\theta_{2}''} \\
&= 
\frac{\partial M_{12}}{\partial \theta_{1}}  \gruen{\theta_{1}'}^2 
 + \frac{\partial M_{12}}{\partial \theta_{2}} \gruen{\theta_{1}'} \dunkelrot{\theta_{2}'} 
 + M_{\gruen{1}\dunkelrot{2}} \gruen{\theta_{1}''}
 + \frac{\partial M_{22}}{\partial \theta_{1}} \gruen{\theta_{1}'} \dunkelrot{\theta_{2}'} 
 + \frac{\partial M_{22}}{\partial \theta_{2}}  \dunkelrot{\theta_{2}'}^2 
 + M_{\dunkelrot{22}} \dunkelrot{\theta_{2}''}
\end{align*}

Es gilt 
% Ableitung d/dt dT/d theta_1' - dT/d theta_1
\begin{align*}
    \frac{\mathrm{d}}{\dt} \frac{\partial T}{\partial \gruen{\theta_{1}'}}  - \frac{\partial T}{\partial \gruen{\theta_{1}}}
    &=
    \left[ \frac{\partial M_{11}}{\partial \gruen{\theta_{1}}} - \frac{1}{2}  \frac{\partial M_{11}}{\partial \gruen{\theta_{1}}} \right] \gruen{\theta_{1}'}^2
    + \left[ \frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}} + \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} -  \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} \right] \gruen{\theta_{1}'} \dunkelrot{ \theta_{2}'} 
    + \left[\frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}} - \frac{1}{2} \frac{\partial M_{22}}{\partial \gruen{\theta_{1}}} \right] \dunkelrot{\theta_{2}'}^2 \\
    & \quad
    +  M_{\gruen{1 1}} \gruen{\theta_{1}''} 
    + M_{\gruen{1}\dunkelrot{2}} \dunkelrot{\theta_{2}''}
\end{align*}

% Ableitung d/dt dT/d theta_2' - dT/d theta_2
\begin{align*}
\frac{\mathrm{d}}{\dt} \frac{\partial T}{\partial \dunkelrot{\theta_{2}'}} - \frac{\partial T}{\partial \dunkelrot{\theta_{2}}}
&= 
\left[ \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} - \frac{1}{2} \frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}} \right] \gruen{\theta_{1}'}^2 
+ \left[ \frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}} + \frac{\partial M_{22}}{\partial \gruen{\theta_{1}}} - \frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}} \right] \gruen{\theta_{1}'} \dunkelrot{\theta_{2}'} 
+ \left[ \frac{\partial M_{22}}{\partial \dunkelrot{\theta_{2}}} - \frac{1}{2} \frac{\partial M_{22}}{\partial \dunkelrot{\theta_{2}}} \right]  \dunkelrot{\theta_{2}'}^2 \\
& \quad + M_{\gruen{1}\dunkelrot{2}} \gruen{\theta_{1}''} + D_{\dunkelrot{22}} \dunkelrot{\theta_{2}''} \\
&=
\underbrace{\left[ \frac{\partial M_{12}}{\partial \gruen{\theta_{1}}} \gruen{\theta_{1}'} - \frac{1}{2} \frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}} \gruen{\theta_{1}'} \right]}_{C_{\dunkelrot{2}\gruen{1}}} \gruen{\theta_{1}'}
+ \underbrace{\left[ \frac{1}{2} \frac{\partial M_{22}}{\partial \dunkelrot{\theta_{2}}}  \dunkelrot{\theta_{2}'} + \frac{\partial M_{22}}{\partial \gruen{\theta_{1}}} \gruen{\theta_{1}'} \right]}_{C_{\dunkelrot{22}}}  \dunkelrot{\theta_{2}'}
+ M_{\gruen{1}\dunkelrot{2}} \gruen{\theta_{1}''} + M_{\dunkelrot{22}} \dunkelrot{\theta_{2}''}
\end{align*}

Für die Einträge der Matrix $C$ gilt
% Berechnung der Einträge der Coriolis-Matrix C
\begin{align*}
C_{11} 
&=
\frac{1}{2}  \underbrace{\frac{\partial M_{11}}{\partial \gruen{\theta_{1}}} }_{= 0} \gruen{\theta_{1}'} + \underbrace{\frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}}}_{ =  -2m_2 l_1 a_2 \sin(\dunkelrot{\theta_2})} \dunkelrot{ \theta_{2}'}
=
-2m_2 l_1 a_2 \sin(\dunkelrot{\theta_2}) \dunkelrot{ \theta_{2}'} 
\\
C_{12}
&=
\underbrace{\frac{\partial M_{12}}{\partial \dunkelrot{\theta_{2}}}}_{= - m_2 l_1 a_2 \sin(\dunkelrot{\theta_2})} \dunkelrot{\theta_{2}'} - \frac{1}{2} \underbrace{\frac{\partial M_{22}}{\partial \gruen{\theta_{1}}}}_{ = 0} \dunkelrot{\theta_{2}'}
=
- m_2 l_1 a_2 \sin(\dunkelrot{\theta_2}) \dunkelrot{\theta_{2}'}
\\
C_{21} 
&= \underbrace{\frac{\partial M_{12}}{\partial \gruen{\theta_{1}}}}_{= 0} \gruen{\theta_{1}'} - \frac{1}{2} \underbrace{\frac{\partial M_{11}}{\partial \dunkelrot{\theta_{2}}}}_{= -2m_2 l_1 a_2 \sin(\dunkelrot{\theta_2}) } \gruen{\theta_{1}'}
=
m_2 l_1 a_2 \sin(\dunkelrot{\theta_2})\gruen{\theta_{1}'}
\\
C_{22} 
&=
\frac{1}{2} \underbrace{\frac{\partial M_{22}}{\partial \dunkelrot{\theta_{2}}}}_{ = 0} \dunkelrot{\theta_{2}'} + \underbrace{ \frac{\partial M_{22}}{\partial \gruen{\theta_{1}}}}_{ = 0} \gruen{\theta_{1}'}
= 0
\end{align*}

Es gilt somit 
% Resultat Coriolis-Matrix C(q, qdot) * qdot
\begin{align*}
C(\textbf{q}, \dot{\textbf{q}}) \cdot \dot{\textbf{q}}
=
\begin{pmatrix}
    -2m_2 l_1 a_2 \sin(\dunkelrot{\theta_2}) \dunkelrot{ \theta_{2}'} 
    &
    - m_2 l_1 a_2 \sin(\dunkelrot{\theta_2}) \dunkelrot{\theta_{2}'} 
    \\
    m_2 l_1 a_2 \sin(\dunkelrot{\theta_2})\gruen{\theta_{1}'}
    &
    0
\end{pmatrix}
\begin{pmatrix}
    \gruen{\theta_{1}'} \\
    \dunkelrot{\theta_{2}'} 
\end{pmatrix}
\end{align*}

\subsubsection{Gravitationsterme}

Für die potenzielle Energie $V$ gilt:
% V = m*g*h als Potenzielle Energie
\begin{align*}
    V 
    &= m_1 \cdot g \cdot y_1 + m_2 \cdot g \cdot y_2 
    = m_1  g  a_1 \sin(\gruen{\theta_1}) 
    + m_2  g \left( l_1 \sin(\gruen{\theta_1}) 
    + a_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) \right)
\end{align*}

Für die partiellen Ableitungen erhalten wir
% Berechnung der Gravitationsterme G(q) = dV/dq
\begin{align*}
    G(\textbf{q})
    =
    \frac{\partial V}{\partial \textbf{q}}
    =
    \begin{pmatrix}
        \frac{\partial V}{\partial \gruen{\theta_1}} \\
        \frac{\partial V}{\partial \dunkelrot{\theta_2}}
    \end{pmatrix}
    =
    \begin{pmatrix}
        m_1  g  a_1 \cos(\gruen{\theta_1}) + m_2  g \left( l_1 \cos(\gruen{\theta_1}) 
        + a_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) \right) \\
        m_2  g \left( l_1 \cos(\gruen{\theta_1}) + a_2 \cos(\gruen{\theta_1} 
        + \dunkelrot{\theta_2}) \right)
    \end{pmatrix}
\end{align*}

% Hier Berechnung für zusätzliches Gewicht an link2
\newpage
\subsection{Einfaches Greifobjekt}
Wir modellieren ein Variables Greifobjekt, welches am Ende von Link 2 gehalten wird. 
Wir betrachten nachfolgend das Greifobjekt als Punktmasse mit Masse $m_G$. 

% Greifobjekt
%--------------------------------------------------------------------------------------------------------
\begin{center}
    \begin{tikzpicture}[scale = 1.75, every node/.style={transform shape}]
        % Koordinatensystem
        %\draw[very thin, gray] (-5,-5) grid (5,5); % Raster
        %\draw[->] (-5,0) -- (5,0); % x-Achse
        %\draw[->] (0,-5) -- (0,5); % y-Achse
        
        % Erste Zeichnung (Original)
        \fill[hellblau] (-4,-1) circle (0.25);  % Füllt das Objekt mit hellblau
        %\draw[white, line width = 0.2mm] (-4,-1) circle (0.25);  % Weißer Rand um das Objekt
        
        %\draw[white, line width = 0.2mm] (-4.25,-1.4) rectangle (-3.75,-1);  % Weißer Rand um das Rechteck
        \fill[hellblau] (-4.25,-1.4) rectangle (-3.75,-1);  % Füllt das Rechteck mit hellblau
        %\draw[thick, white] (-4.5,-1.4) -- (-3.5,-1.4);
        
        % Grüne Linie angepasst (Endpunkt auf (-2.0, 0.0))
        \draw[thick, gruen] (-4,-1) -- (-3.0,1.0);
        
        % Rote Linie angepasst (von (-2.0, 0.0) nach (-1.0, 2.0))
        \draw[thick, dunkelrot] (-3.0,1.0) -- (-1.0,1.0);
        
        % Glieder
        \fill[blau] (-3.0,1.0) circle (0.1);
        \draw[white, thin] (-3.0,1.0) circle (0.1);  % Weißer Rand um das Objekt
        \fill[blau] (-4.0,-1.0) circle (0.1);
        \draw[white, thin] (-4.0,-1.0) circle (0.1);  % Weißer Rand um das Objekt
        
        % Beschriftungen
        \node at (-3, -0.75) {\tiny $\gruen{l_1}$};  % 
        \node at (-1.5, 1.5) {\tiny $\dunkelrot{l_2}$};  % 
        
        % Schwerpunkte 
        %\fill[white] (-3.0,-0.5) circle (0.05);
        %\fill[white] (-1.5,1) circle (0.05);
        
        %\draw[white, <->] (-1.85,0.15) -- (-1.5,0.85);
        %\draw[white, <->] (-3.85,-0.85) -- (-3.1,-0.45);
        
        % Beschriftungen
        \node at (-3.5, -0.4) {\tiny $a_1$};  % 
        \node at (-1.5, 0.5) {\tiny $a_2$};  % 

        \draw[dunkelrot, thick] (-1.0,0.9) -- (-1.0, 1.1);
        \draw[dunkelrot, thick] (-1.0,0.9) -- ++(0.1,0.0);
        \draw[dunkelrot, thick] (-1.0,1.1) -- ++(0.1,0.0);
        \node at (-0.6,0.7) {\tiny $m_G$}; % Beschriftung

        % Erste Zeichnung (Original) verschoben um +4 in x
        \fill[hellblau] (0,-1) circle (0.25);  % Füllt das Objekt mit hellblau
        \draw[white, line width = 0.2mm] (0,-1) circle (0.25);  % Weißer Rand um das Objekt
        
        \draw[white, line width = 0.2mm] (-0.25,-1.4) rectangle (0.25,-1);  % Weißer Rand um das Rechteck
        \fill[hellblau] (-0.25,-1.4) rectangle (0.25,-1);  % Füllt das Rechteck mit hellblau
        \draw[thick, white] (-0.5,-1.4) -- (0.5,-1.4);
        
        % Grüne Linie angepasst (Endpunkt auf (1.0, 1.0))
        \draw[thick, gruen] (0,-1) -- (1.0,1.0);
        
        % Rote Linie angepasst (von (1.0, 1.0) nach (3.0, 1.0))
        \draw[thick, dunkelrot] (1.0,1.0) -- (3.0,1.0);

        % Orange Linie zum Greifobjekt
        \draw[thick, orange] (3.0,1.0) -- (3.3,1.4);
        \draw[thick, orange] (3.364,1.352) -- (3.236,1.448);
        \draw[thick, orange] (3.364,1.352) -- ++(0.072,0.096);
        \draw[thick, orange] (3.236,1.448) -- ++(0.072,0.096);

        % Winkel
        \draw [orange, thick] (3.35,1.0)  arc[start angle=0,end angle=45,radius=0.35cm];
	    \node at (3.25, 0.9) {\tiny $\orange{\theta_3}$};  % Winkelbeschriftung
        \draw[thick, dunkelrot, dotted] (3,1) -- (4.0,1.0);
        \node at (3.0, 1.3) {\tiny $\orange{l_3}$};

        \fill[blau] (3.0,1.0) circle (0.1);
        \draw[white, thin] (3.0,1.0) circle (0.1);  % Weißer Rand um das Objekt

        % Glieder
        \fill[blau] (1.0,1.0) circle (0.1);
        \draw[white, thin] (1.0,1.0) circle (0.1);  % Weißer Rand um das Objekt
        \fill[blau] (0.0,-1.0) circle (0.1);
        \draw[white, thin] (0.0,-1.0) circle (0.1);  % Weißer Rand um das Objekt
    \end{tikzpicture}
\end{center}
%--------------------------------------------------------------------------------------------------------

Für die Masse von Link 2 inklusive Greifobjekt gilt:
% m_i' = m_i + m_G
\begin{align*}
    m_{i}' = m_{i} + m_{G}
\end{align*}

Für den Schwerpunkt von Link 2 inklusive Greifobjekt gilt:
% a_i' = (m_i * a_i + m_G * d) / (m_i + m_G)
\begin{align*}
    \textbf{a}_{2}'
    &= \frac{m_{i} \cdot \textbf{a}_{2} + m_{G} \cdot \textbf{d}}{m_{i} + m_{G}}
    \quad
    \textbf{d}(\orange{\theta_3}) =
    \begin{pmatrix}
        l_2 + r \cdot \cos(\orange{\theta_3}) \\
        r \cdot \sin(\orange{\theta_3}) \\
        0
    \end{pmatrix}
\end{align*}

Für den Trägheitstensor von Link 2 inklusive Greifobjekt gilt:
% I_i' = I_i + m_i * S(a_i - a_i') + m_G * S(d - a_i')
\begin{align*}
    I_{i}' 
    &= 
    I_{i} + m_{i} \cdot S(\textbf{a}_{i} - \textbf{a}_{i}') 
    + m_{G} \cdot S(\textbf{d} - \textbf{a}_{i}')
    \quad
    S(\textbf{v}) =
    \begin{pmatrix}
        v_{y}^2 + v_{z}^2 & -v_{x} v_{y} & -v_{x} v_{z} \\
        -v_{x} v_{y} & v_{x}^2 + v_{z}^2 & -v_{y} v_{z} \\
        -v_{x} v_{z} & -v_{y} v_{z} & v_{x}^2 + v_{y}^2
    \end{pmatrix}
\end{align*}

Wobei $S(\textbf{v})$ die Steiner-Matrix ist. 
Wir erhalten die Matrix direkt aus der Definition des Trägheitstensors (\ref{eq:traegheitstensor}) einer Punktmasse
mit $\rho(\textbf{r}) = m \cdot \delta(\text{r}-\textbf{d})$.
Für die Verschiebungsvektoren gilt:
% Berechnung a_2'
\begin{align*}
    \textbf{d}
    =
    \begin{pmatrix}
        l_2 \\
        0 \\
        0 
    \end{pmatrix}
    \textbf{a}_{2} =
    \begin{pmatrix}
        \frac{l_2}{2} \\
        0 \\
        0 
    \end{pmatrix}
    \Rightarrow
    \textbf{a}_{2}'
    =
    \frac{l_2}{m_{2} + m_{G}}
    \begin{pmatrix}
        \frac{m_{2}}{2} + m_{G} \\
        0 \\
        0
    \end{pmatrix}
\end{align*}

Für die Steiner-Matrizen gilt entsprechend
% Berechnung der Steiner-Matrizen
\begin{align*}
    S(\textbf{a}_{2} - \textbf{a}_{2}')
    =
    \begin{pmatrix}
        0 & 0 & 0 \\
        0 & \left[\frac{l_2}{2} - a_{2}'\right]^2 & 0 \\
        0 & 0 & \left[\frac{l_2}{2} - a_{2}'\right]^2
    \end{pmatrix}
    \quad
    S(\textbf{d} - \textbf{a}_{2}')
    =
    \begin{pmatrix}
        0 & 0 & 0 \\
        0 & \left[l_2^2 - a_{2}'\right]^2 & 0 \\
        0 & 0 & \left[l_2^2 - a_{2}'\right]^2
    \end{pmatrix}
\end{align*}

Somit erhalten wir für den Trägheitstensor von Link 2 inklusive Greifobjekt:
% Berechnung I_2'
\begin{align*}
    I_{2}'
    &=
    \begin{pmatrix}
        I_{2,xx} & 0 & 0 \\
        0 & I_{2,yy} 
        + m_2 \cdot \left[\frac{l_2^2}{2} - a_{2}'\right]^2 
        + m_G \cdot \left[\frac{l_2^2}{2} - a_{2}'\right]^2 
        & 0 \\
        0 & 0 & I_{2,zz} 
        + m_2 \cdot \left[\frac{l_2^2}{2} - a_{2}'\right]^2 
        + m_G \cdot \left[\frac{l_2^2}{2} - a_{2}'\right]^2
    \end{pmatrix}
\end{align*}

Für die Koordinaten des Schwerpunktes von Link 3 gilt:
% Berechnung der Koordinaten des Schwerpunktes von Link 3
\begin{align*}
    \textbf{r}_3
    &=
    \begin{pmatrix}
        l_1 \cos(\gruen{\theta_1}) 
        + l_2 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        + l_3 \cos(\gruen{\theta_1} + \dunkelrot{\theta_2} + \orange{\theta_3}) \\
        l_1 \sin(\gruen{\theta_1}) 
        + l_2 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2}) 
        + l_3 \sin(\gruen{\theta_1} + \dunkelrot{\theta_2} + \orange{\theta_3}) \\
        0
    \end{pmatrix}
\end{align*}
Berechnung der Jacobi-Matrizen für Link 3 bezüglich der Geschwindigkeiten:
% Jacobi-Matrizen für Link 3
\begin{align*}
    J_{v_3} &=
    \frac{\partial \textbf{r}_3}{\partial \textbf{q}}
\end{align*}

Für die Winkelgeschwindigkeit des Links 3 setzen wir 
$\bm{\omega_3}= 
\begin{pmatrix} 
    0 & 0 & \gruen{\theta_1'} + \dunkelrot{\theta_2'} + \orange{\theta_3'} 
\end{pmatrix}$

und erhalten für die Jacobi-Matrix bezüglich der Winkelgeschwindigkeit:
% Jacobi-Matrizen für Link 3
\begin{align*}
    J_{\omega_3} &=
    \frac{\partial \bm{\omega_3}}{\partial \dot{\textbf{q}}} 
    =
    \begin{pmatrix}
        0 & 0 & 0 \\
        0 & 0 & 0 \\
        1 & 1 & 1
    \end{pmatrix}
\end{align*}

\newpage

% Systemparameter
\newcommand{\mG}{m_G}

% Aktualisierte Parameter für Link 2 mit Greifobjekt
\newcommand{\mtwoPrime}{m_2'}
\newcommand{\atwoPrime}{a_2'}
\newcommand{\ItwozzPrime}{I_{2,zz}''}

\begin{align*}
    % Massenmatrix
    M(\theta) &= \begin{pmatrix}
        M_{11} & M_{12} \\
        M_{21} & M_{22}
    \end{pmatrix} \\
    M_{11} &= m_1 a_1^2 + I_{1,zz} + \mtwoPrime\left(L_1^2 + \atwoPrime^2 + 2L_1 \atwoPrime \cos\theta_2\right) + \ItwozzPrime \\
    M_{12} &= M_{21} = \mtwoPrime\left(\atwoPrime^2 + L_1 \atwoPrime \cos\theta_2\right) + \ItwozzPrime \\
    M_{22} &= \mtwoPrime \atwoPrime^2 + \ItwozzPrime
\end{align*}

\begin{align*}
    % Coriolis- und Zentrifugalmatrix
    C(\theta, \dot{\theta}) &= \begin{pmatrix}
        C_{11} & C_{12} \\
        C_{21} & C_{22}
    \end{pmatrix} \\
    C_{11} &= -\mtwoPrime L_1 \atwoPrime \sin\theta_2 \cdot \dot{\theta}_2 \\
    C_{12} &= -\mtwoPrime L_1 \atwoPrime \sin\theta_2 \cdot (\dot{\theta}_1 + \dot{\theta}_2) \\
    C_{21} &= \mtwoPrime L_1 \atwoPrime \sin\theta_2 \cdot \dot{\theta}_1 \\
    C_{22} &= -\mtwoPrime L_1 \atwoPrime \sin\theta_2 \cdot \dot{\theta}_1
\end{align*}

\begin{align*}
    % Gravitationsterm
    G(\theta) &= \begin{pmatrix}
        G_1 \\
        G_2
    \end{pmatrix} \\
    G_1 &= m_1 g a_1 \cos\theta_1 + \mtwoPrime g \left(L_1 \cos\theta_1 + \atwoPrime \cos(\theta_1 + \theta_2)\right) \\
    G_2 &= \mtwoPrime g \atwoPrime \cos(\theta_1 + \theta_2)
\end{align*}

% Dynamikgleichung
\begin{equation*}
    M(\theta)\ddot{\theta} + C(\theta, \dot{\theta}) + G(\theta) = \tau
\end{equation*}

% Aktualisierte Parameter
\begin{align*}
    \mtwoPrime &= m_2 + \mG \\
    \atwoPrime &= L_2 \cdot \frac{m_2/2 + \mG}{m_2 + \mG} \\
    \ItwozzPrime &= \frac{1}{12}m_2 L_2^2 + \frac{m_2 \mG L_2^2}{4(m_2 + \mG)}
\end{align*}

\begin{tabular}{c c c}
    Parameter & Ohne Greifobjekt & Mit Greifobjekt \\
    \hline
    Masse Link 2 & $m_2$ & $m_{2}' = m_2 + m_G$ \\
    Schwerpunkt Link 2 
    & $a_2 = \frac{L_2}{2}$ 
    & $a_{2}' = \frac{L_2}{m_2 + m_G} \left(\frac{m_2}{2} + m_G\right)$ \\
    Trägheitstensor Link 2 
    & $I_{2,zz} = \frac{1}{12} m_2 L_2^2$ 
    & $I_{2,zz}' = \frac{1}{12}m_2 L_2^2 + \frac{m_2 m_G L_2^2}{4(m_2 + m_G)}$ \\
\end{tabular}
\newpage


%------------------------------------------------------------------------------------------------------------
\section{Theorie optimaler Steuerungungsprobleme}
Wir betrachten ein Steuerungsproblem und definieren die Value-Function $V$ mittels
%
\begin{align*}
V(x(t),\dunkelgelb{t}) := \min_{\dunkelrot{u}} \left\{ \int_{\dunkelgelb{t}}^{t_f} L(s,x(s),\dunkelrot{u}(s)) \ds + \Phi(x(t_f)) \right\}
\end{align*}

\begin{satz}[Hamilton-Jacobi-Bellman Gleichung]
Die Value-Function erfüllt
%
\begin{align*}
0 = \frac{\partial V(x, t)}{\partial t} + \min_{u} \left[ L(t,x, u) + \frac{\partial V(x,t)}{\partial x} \cdot f(t,x,u) \right], \quad x \in \mathbb{R}^n, \, t_0 \leq t \leq t_f
\end{align*}
%
mit den Randbedingungen
%
\begin{align*}
V(x, \lila{t_f}) = \Phi(x(\lila{t_f})) \quad V(x, \dunkelgelb{t_0} ) = \min_u \int_{\dunkelgelb{t_0}}^{t_f} L(t,x(t),u(t)) \dt + \Phi(x(t_f)) 
\end{align*}
\end{satz}

%------------------------------------------------------------------------------------------------------------
\proof{ 

Die Value-Function $V(x,t)$ beschreibt die minimalen Kosten von Zustand $x$ zum Endzeitpunkt $t_f$.  Für $s \in [t,t_f]$ gilt
%
\begin{itemize}
\item Systemdynamik
%
\begin{align*}
x'(s) = f(x(s), u(s)), \quad x(t) = x
\end{align*}

\item Kostenfunktional
%
\begin{align*}
J(u) = \int_t^{t_f} L(s,x(s),u(s)) \ds + \Phi(x(t_f))
\end{align*}
\end{itemize}

Angenommen, wir wechseln zum Zeitpunkt $t+h$ zu einer optimalen Steuerung, dann gilt für unser Zielfunktional 
%
\begin{align*}
J(u) 
&= \int_{t}^{t+h} L(s,x(s),u(s)) \ds + \dunkelrot{\int_{t+h}^{t_f} L(s,x(s),u(s)) \ds + \Phi(x(t_f)) } \\
&= \int_{t}^{t+h} L(s,x(s),u(s)) \ds + \dunkelrot{V(x(t+h),t+h)} 
\end{align*}

Da $V(x(t), t)$ die minimalen Kosten vom Zustand $x$ zur Zeit $t$ angibt, gilt:
%
\begin{align*}
V(x(t),t) 
&\leq \int_{t}^{t+h} L(s,x(s),u(s)) \ds + \dunkelrot{V(x(t+h),t+h)} \\
\Rightarrow 0 &\leq \int_{t}^{t+h} L(s,x(s),u(s)) \ds + \dunkelrot{V(x(t+h),t+h)} - V(x(t),t) 
\end{align*}

Im Grenzübergang $h \to 0$ erhalten wir
%
\begin{align*}
0 &\leq \gruen{\lim_{h \to 0}  \frac{1}{h}  \int_{t}^{t+h} L(s,x(s),u(s)) \ds} + \dunkelrot{\lim_{h \to 0} \frac{ V(x(t+h),t+h) - V(x,t) }{h}} \\
&= \gruen{ L(t,x(t),u(t))} + \dunkelrot{\frac{\mathrm{d}}{\dt} V(x(t),t)} \\
&= \gruen{ L(t,x(t),u(t))} + \dunkelrot{\frac{\partial V}{\partial t}  + \frac{\partial V}{\partial x} \cdot x'(t)} \\
&= \gruen{ L(t,x(t),u(t))} + \dunkelrot{\frac{\partial V}{\partial t}  + \frac{\partial V}{\partial x} \cdot f(t,x(t), u(t))}
\end{align*}

Durch Minimierung bezüglich $u$ erhalten wir die Gleichheit und somit
%
\begin{align*}
0 &= \frac{\partial V}{\partial t} + \orange{\min_{u} \left[L(t,x(t),u(t)) +  \frac{\partial V}{\partial x} \cdot f(t,x(t), u(t))   \right]} \\
&= \frac{\partial V}{\partial t} + \orange{\textsf{H}\left(t,x(t) , \frac{\partial V}{\partial x}(t,x(t)) \right)}
\end{align*}
}
%------------------------------------------------------------------------------------------------------------


\subsection{Herleitung des Minimumprinzips}

Berechnung der totalen Ableitung der Value-Function $V$ entlang der Charakteristik $x(t)$:
%
\begin{align*}
\frac{dV}{dt} &= \blau{\frac{\partial V}{\partial x}} \frac{dx}{dt} + \lila{\frac{\partial V}{\partial t}} = \blau{p(x,t)} \cdot x'(t) \lila{- H\left( t,x , \frac{\partial V}{\partial x} \right)} \\
\end{align*}

Berechnung der totalen Ableitung von $p = \frac{\partial V}{\partial x}$:
%
\begin{align*}
\frac{dp}{dt} &= \frac{\mathrm{d}}{\dt} \left( \frac{\partial V}{\partial x} \right) =  \frac{\partial^2 V}{\partial x^2} \cdot x'(t) + \rot{\frac{\partial V}{\partial x \partial t}}
\end{align*}

Differenzieren der HJB bezüglich $x$ liefert
%
\begin{align*}
0 = \frac{\mathrm{d}}{\dx} \left[ \frac{\partial V}{\partial t} + H\left(t,x, \orange{ \frac{\partial V}{\partial x}} \right) \right] = \rot{\frac{\partial V}{\partial t \partial x}} + \frac{\partial H}{\partial x} + \frac{\partial H}{\partial \orange{p}} \cdot \frac{\partial^2 V}{\partial x^2}
\end{align*}

Einsetzen der Gleichung liefert:
%
\begin{align*}
\frac{dp}{dt} =  \frac{\partial^2 V}{\partial x^2} \cdot x'(t) + \rot{\left(- \frac{\partial H}{\partial x} - \frac{\partial H}{\partial p} \cdot \frac{\partial^2 V}{\partial x^2} \right)}
= \frac{\partial^2 V}{\partial x^2} \cdot \gruen{\left(x'(t) - \frac{\partial H}{\partial p} \right)} - \frac{\partial H}{\partial x}
\end{align*}

Wir erhalten somit die bekannten, notwendigen Optimalitätsbedingungen:
%
\begin{align*}
p'(t) = -H_x , \quad \gruen{x'(t) = f(t,x,u^*)}, \quad u^* = \textsf{argmin} \left[ L(t,x,u)+ p(t,x)f(t,x,u) \right]
\end{align*}

%-----------------------------------------------------------------------------------------------------------
\subsection{Anwendung auf Linear-Quadratische Probleme}

\subsubsection{Finite time problem}

Gegeben sei das Steuerungsproblem 
%
\begin{align*}
\min_u &  \int_{\dunkelgelb{t_0}}^{t_f} x^T Q x + u^T R u \dt + \underbrace{(x(t_f)- x_f)^T S (x(t_f)- x_f)}_{x(t_f)^T S x(t_f) -2x_{f}^T S x(t_f) +x_{f}^{T} S x_f} 
= V(\dunkelgelb{t_0},x(\dunkelgelb{t_0})) + x_{f}^{T} S x_f
\end{align*}

unter der Nebenbedingung $x'(t) = Ax+Bu$ und $x(t_0) = x_0$. Der Term $x_{f}^{T} S x_f$ ist unabhängig von $u$ und kann bei der Minimierung weggelassen werden.

% Aufbau der Value Funktion und HJB
%----------------------------------------------------------------------------------------------
%\begin{itemize}
%\item Als Ansatz für die Value-Funktion wählen wir 
%
\begin{align*}
V(x,t) 	&= x^T K(t) x + 2 s(t)^T x +r(t) \quad V(x,t_f) = x(t_f)^T K(t_f) x(t_f) + 2 s(t_f)^T x(t_f) + r(t_f)
\end{align*}

Wir erhalten für die Endwerte
%
\begin{align*}
K(t_f) = S, \quad s(t_f) = - S x_f \quad r(t_f) = 0
\end{align*}

%\item Für die partiellen Ableitungen gilt:
%
\begin{align*}
V_t = x^T K'(t) x + 2 s'(t)^T x +r'(t) \quad \rot{V_x = 2K(t)x +2s(t)} 
\end{align*}


%\item Minimierung bezüglich $u$ liefert 
%
\begin{align*}
\frac{\partial}{\partial u} \left[ x^T Q x + u^T R u + V_x^T \cdot (Ax+Bu) \right] &= 2Ru + B^T \cdot V_x \Rightarrow u^{*}(t) = - \frac{1}{2} R^{-1} B^T \rot{V_x}
\end{align*}

%\item Da $R^T = R$ gilt, folgt $(R^{-1})^T = R^{-1}$ und $K^T = K$, da Hesse-Matrix von $V$. %   weiter mit $u^{*}$
%

% Hier weitermachen und ausmultiplizieren
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{align*}
(u^{*})^T R u^{*} 
&=  \left(- \frac{1}{2} R^{-1} B^T V_x \right)^T R \left(- \frac{1}{2} R^{-1} B^T V_x \right) \\
&= \frac{1}{4} \cdot \left( R^{-1} B^T \rot{V_x} \right)^T R \left( R^{-1} B^T \rot{V_x} \right) \\
&= \frac{1}{4} \cdot \left(\rot{2} R^{-1} B^T \rot{(K(t)x + s(t))} \right)^T R \left( \rot{2} R^{-1} B^T \rot{(K(t)x + s(t))} \right) \\
&=  (K(t)x + s(t))^T \orange{B R^{-1}} \gruen{ R R^{-1}} \orange{B^T} (K(t)x + s(t)) \\
&=    < K(t)x + s(t) , \orange{P} (2K(t)x + s(t)) >  \\
&=  < K(t)x, P K(t)x > +  \underbrace{< K(t)x, Ps(t) >}_{< s(t),  \orange{P^{T}} K(t)x  >} + < s(t), P K(t)x  > + <s(t), P s(t) >  \\
&= x^T K(t)^T P K(t)x + 2 \cdot s(t)^T P K(t) x +  s(t)^T P s(t)
\end{align*}

mit $P = B R^{-1} B^T$ und $P^T = P$.  
%

\begin{align*}
V_x^{T}  \left( - \frac{1}{2} B R^{-1} B^T V_x \right)
&= (2K(t)x +2s(t))^T \left( - \frac{1}{2} B R^{-1} B^T (2K(t)x +2s(t)) \right) \\
&= -2 \cdot (K(t)x + s(t))^T P (K(t)x + s(t)) \\
&= -2 \cdot x^T K(t)^T P K(t)x -4 \cdot s(t)^T P K(t)x -2 \cdot s(t)^T P s(t) 
\end{align*}

\begin{align*}
V_x^T Ax &= 2 (K(t)x + s(t))^T A x = 2 x^T K(t)^T A x + 2 s(t)^T Ax = x^T (K(t)^T A + A^T K(t) ) x + 2 s(t)^T Ax
\end{align*}


\begin{align*}
- V_t 	&= \min_u \left[ x^T Q x + u^T R u + V_x^T \cdot (Ax+Bu) \right] 
\end{align*}



\begin{align*}
- V_t 								&=  x^T Q x + (u^{*})^T R u^{*}  + V_x^T \cdot \left( Ax- \frac{1}{2} B R^{-1} B^T V_x \right) 
\\
\dunkelrot{-} x^T \dunkelrot{K'(t)} x - 2 \blau{s'(t)}^T x  -\orange{r'(t)} 	&= x^T (\dunkelrot{Q-KPK+ KA + A^T K}) x - 2 \cdot (\blau{(P K -A)^T s(t)})^T x - \orange{ s(t)^T P s(t)}
\end{align*}

\begin{align*}
K'(t) &= -Q+K(t) B R^{-1} B^T K(t) - K(t) A - A^T K(t) \quad K(t_f) = S \\
s'(t) &= (K(t) B R^{-1} B^T  - A^T) s(t) \quad s(t_f) = -S x_f  \\
r'(t) &= s(t)^T B R^{-1} B^T s(t) \quad r(t_f) = 0
\end{align*}

\subsubsection{infinite time problem}

Im Grenzfall $t \to \infty$ betrachten wir das Steuerungsproblem
%
\begin{align*}
\min_u &  \int_{\dunkelgelb{t_0}}^{\infty} (x-x_f)^T Q (x-x_f)  + u^T R u \dt 
= V(x(\dunkelgelb{t_0}))
\end{align*}

unter der Nebenbedingung $x'(t) = Ax+Bu$ und $x(t_0) = x_0$. Als Ansatz für die Value Funktion wählen wir erneut 
%
\begin{align*}
V(x) = x^T K x + 2s^T x + r \Rightarrow V_x = 2Kx + 2s
\end{align*}

Es gilt erneut 
%
\begin{align*}
\frac{\partial}{\partial u} \left((x-x_f)^T Q (x-x_f)  + u^T R u  + V_x^T (Ax+Bu) \right) = 2Ru + B^T V_x  = 0 \Rightarrow u^{*} = -\frac{1}{2} R^{-1} B^T V_x 
\end{align*}


\begin{align*}
(x-x_f)^T Q (x-x_f) 
&= x^T Q x - 2 x_f^T Q x + x_f^T Q x_f
\end{align*}

\begin{align*}
0 &= x^T ( Q - KPK + KA + A^T K ) x -2 ((PK-A)^T s + Qx_f)^T x - s^T (P) s + x_f^T Q x_f
\end{align*}

\newpage
%----------------------------------------------------------------------------------------------


\section{Numerische Lösungsverfahren}


\subsection{Gradientenverfahren}

\begin{align*}
u(t) + \epsilon \cdot \eta_u (t) \quad x(t) + \epsilon \cdot \eta_x (t), \eta_x (0) = 0
\end{align*}

Um die Zustandsgleichung als Nebenbedingung zu integrieren, führen wir einen Lagrange-Multiplikator \( p(t) \) ein. Das erweiterte Zielfunktional lautet dann:

\[
J^{\text{aux}}(u, x, p) = \int_{0}^{T} \left[ L(x(t), u(t), t) + p(t) \left( f(x(t), u(t)) - \dot{x}(t) \right) \right] \mathrm{d}t + \Phi(x(T))
\]


Wir betrachten kleine Variationen der Steuerungsfunktion und des Zustands:



wobei \( \varepsilon \) ein kleiner Parameter ist.



Die Variation von \( J^{\text{aux}} \) bezüglich \( \varepsilon \) bei \( \varepsilon = 0 \) ergibt:

\[
\delta J^{\text{aux}} = \int_{0}^{T} \left[ \frac{\partial L}{\partial x} \delta x(t) + \frac{\partial L}{\partial u} \delta u(t) + p(t) \left( \frac{\partial f}{\partial x} \delta x(t) + \frac{\partial f}{\partial u} \delta u(t) - \delta \dot{x}(t) \right) \right] \mathrm{d}t + \frac{\partial \Phi}{\partial x}(x(T)) \delta x(T) = 0
\]


Der Term mit \( \delta \dot{x}(t) \) wird mittels Integration durch Teile umgeformt:

\[
\int_{0}^{T} p(t) (-\delta \dot{x}(t)) \, \mathrm{d}t = \left[ -p(t) \delta x(t) \right]_{0}^{T} + \int_{0}^{T} \dot{p}(t) \delta x(t) \, \mathrm{d}t
\]

Da \( \delta x(0) = 0 \) ist (weil der Anfangszustand festgelegt ist), vereinfacht sich der Randterm zu:

\[
-p(T) \delta x(T) + \int_{0}^{T} \dot{p}(t) \delta x(t) \, \mathrm{d}t
\]


Setzen wir die Ergebnisse in die Variation des erweiterten Zielfunktionals ein:

\[
\int_{0}^{T} \left[ \left( \frac{\partial L}{\partial x} + p(t) \frac{\partial f}{\partial x} + \dot{p}(t) \right) \delta x(t) + \left( \frac{\partial L}{\partial u} + p(t) \frac{\partial f}{\partial u} \right) \delta u(t) \right] \mathrm{d}t + \left( \frac{\partial \Phi}{\partial x} - p(T) \right) \delta x(T) = 0
\]

Für die Gleichung muss jeder Koeffizient der unabhängigen Variation Null sein. Daher ergeben sich die adjungierten Gleichungen:

\[
\begin{cases}
\dot{p}(t) = -\frac{\partial L}{\partial x} - p(t) \frac{\partial f}{\partial x} \\
p(T) = \frac{\partial \Phi}{\partial x}(x(T))
\end{cases}
\]



Der Gradient des Zielfunktionals \( J(u) \) ist gegeben durch:

\[
\frac{\delta J}{\delta u(t)} = \frac{\partial L}{\partial u} + p(t) \frac{\partial f}{\partial u}
\]

\subsubsection{Sensitivity Approach}

Erweitertes Zielfunktional

\begin{align*}
J^{aux}(u) 	&= \int_0^T \varphi(t,x,u) + p(t) \cdot (f(t,x,u) - x'(t)) \dt + \Phi(x(T)) \\
			&= \int_0^T \underbrace{\varphi(t,x,u) + p(t) \cdot f(t,x,u)}_{= H(t)} \dt \underbrace{-  \int_0^T p(t) x'(t) \dt}_{ = - \left[p(t) x(t) \right]_0^T + \int_0^T p'(t) x(t) \dt} + \Phi(x(T)) \\
			&= \int_0^T H(t) + p'(t)x(t) \dt - \left[p(t) x(t) \right]_0^T + \Phi(x(T)) \\
			&= \int_0^T H(t) + p'(t)x(t) \dt - p(T) x(T) +  \gelb{p(0) x(0)} + \Phi(x(T))
\end{align*}

Der Term $\gelb{p(0) x(0)}$ ist unabhängig von $u$ und fällt bei der Optimierung weg. Bilden der Gateau Ableitung in $u$ entlang $h$ liefert  

\begin{align*}
J'(u,h) &= \int_0^T H_x [t] \cdot S(t)  + H_u [t] \cdot h(t)  + p'(t)S(t)  \dt - p(T) S(T)  + \Phi_x (x(T)) S(1) \\
		&= \int_0^T ( \rot{\underbrace{H_x [t] + p'(t)}_{ = 0}}) \cdot S(t)  + H_u [t] \cdot h(t)  \dt  + ( \lila{\underbrace{\Phi_x (x(T))- p(T)}_{= 0}} ) \cdot S(T)  \\
		&= \int_0^T H_u [t] \cdot h(t)
\end{align*}

Wir erhalten somit $J'(u) = H_u [t]$

\newpage

\subsubsection{Praktische Implementierung}

\begin{beispiel} \label{ex_gradient_1}
Wir betrachten das Steuerungsproblem 
%
\begin{align*}
\min_u \int_0^{1} x(t) + u(t)^2 \dt \quad x'(t) = x(t) + u(t) + 1, \quad \orange{x(0) = 0}.
\end{align*}

welches in einer Aufgabe analytisch gelöst ist. Für den Gradienten gilt
%
\begin{align*}
\nabla J(u) = H_u = \frac{\partial}{\partial u} ( x(t) + u(t)^2 + p(t) \cdot  (x(t) + u(t) + 1) ) = 2u(t) +p(t)
\end{align*} 

Wir verwenden das explizite Euler-Verfahren zur Diskretisierung der Gleichungen aus dem Minimumprinzip: 
%
\begin{itemize}
\item Diskretisierung des Zeitintervalls $[0,1]$ und der Funktionen mittels $\blau{N} \in \mathbb{N}$
%
\begin{align*}
h = \frac{1}{N} \quad \textbf{u}^k = \left(u_i^k \right)_{i=0}^{N}, \quad  \textbf{x}^k = \left( x^{k}_{i} \right)_{i=0}^{N}, \quad \textbf{t}^k = \left( i \cdot h\right)_{i=0}^{N},
\end{align*} 


\item Armijo Suchrichtung $\gruen{\alpha^{(k)}}$:  Für $0 \leq m < \blau{M=10}$,  $\blau{c= 10^{-4},\beta  = 0.5} \in (0,1)$
%
\begin{align*}
u^{\textsf{neu}} 	&= u^k + \beta^m  \cdot d^{(k)} \\
\rot{J(u^k)} 				&= \int_0^1 x^{k}(t) + (u^{k}(t))^2 \dt \rot{\approx h \cdot \sum_{i=0}^{N} x^{k}_{i} + (u^{k}_{i})^2}\\
\rot{J(u^{neu})}			&= \int_0^1 x^{neu}(t) + (u^{neu}(t))^2 \dt \rot{\approx h \cdot \sum_{i=0}^{N} x^{neu}_{i} + (u^{neu}_{i})^2} \\
		J(u^{neu}) &\leq J(u^{k}) \dunkelrot{-} c \cdot \beta^m \cdot \dunkelrot{h \cdot \sum_{i=0}^{N} (2 \cdot u^{(k)}_{i}  + p^{(k)}_{i})(2 \cdot u^{(k)}_{i}  + p^{(k)}_{i})} \\
\Leftrightarrow \rot{J(u^{neu})}		&\leq \rot{J(u^{k})}  \dunkelrot{- \norm{d^{(k)})}^2} \cdot c \cdot \beta^m \Rightarrow \gruen{\alpha^{(k)} = \beta^m} 
\end{align*}

\item Gradientenverfahren: Für $0 \leq \dunkelgelb{k} < MaxIter$, $\blau{\epsilon = 10^{-6}}$:
%
	\begin{itemize}
	\item Forward Integration $x'(t) = x(t) +u(t) +1$
	%
	\begin{align*}
	x^{\dunkelgelb{k}}_{i+1} = x^{\dunkelgelb{k}}_{i} + h \cdot (x^{(\dunkelgelb{k})}_{i} + u^{(\dunkelgelb{k})}_{i} +1) \quad \orange{x^{(k)}_{0} = 0}
	\end{align*}

	\item Backward Integration $p'(t) = -( 1 + p(t) )$
	%
	\begin{align*}
	p^{\dunkelgelb{k}}_{i} = p^{\dunkelgelb{k}}_{i+1} + h \cdot (1 + p^{\dunkelgelb{k}}_{i+1}) \quad \orange{p^{(k)}_{N} = \partial_x \Phi(x(1)) = 0}
	\end{align*}

	\item Berechnung des Gradienten $\nabla J = H_u =2u + p$ 
	%
	\begin{align*}
	d^{(\dunkelgelb{k})}  = -(2 \cdot u^{(\dunkelgelb{k})}  + p^{(\dunkelgelb{k})})
	\end{align*}
	
	\item Berechnung der Schrittweite $\gruen{\alpha^{(k)}}$:
	%
	\begin{align*}
	u^{(\dunkelgelb{k+1})} &= u^{(\dunkelgelb{k})} + \gruen{\alpha^{(k)}} \cdot d^{(\dunkelgelb{k})}  \\
	\norm{u^{(\dunkelgelb{k+1})} - u^{(\dunkelgelb{k})}} &< \blau{\epsilon} \Rightarrow u^{\rot{\textsf{final}}} = u^{(\dunkelgelb{k+1})},  \textsf{ sonst } \dunkelgelb{k \to k+1}
	\end{align*}
	%
	\end{itemize}
%
\end{itemize}


%\includegraphics[width=\textwidth]{ex3.1.plot}
\end{beispiel}

\begin{figure}[h] % H für Positionierung der Grafik
    \centering
    \includegraphics[width=\textwidth]{ex3.1.plot.pdf}
    \captionsetup{labelformat=empty}  % Entfernt "Abbildung 1"
    \caption{Zustand $x$ und Steuerung $u$ mit den Iterationen $\blau{100},\orange{500}$ und der \rot{analytischen Lösung}}
    \label{fig:plot} % Referenz, falls du auf die Grafik verweisen möchtest
\end{figure}

\newpage

\subsection{Riccati Regler}

Es gilt 
%
\begin{align*}
F(K) := Q - KPK + KA + A^T K \Rightarrow F(K) = 0
\end{align*}

% Wichtige Grundbegriffe aus LA
%----------------------------------------------------------------------------
\begin{definition}
Sei $X \in \mathbb{R}^{n \times n}$ dann definieren wir 
%
\begin{align*}
\textsf{vec}(X) = 
\begin{pmatrix}
X_{11} & X_{21} & \cdots & X_{n1} & X_{12} & X_{22} & \cdots X_{nn}  
\end{pmatrix}^T 
\in 
\mathbb{R}^{n^2}
\end{align*}
%
Seien $A \in \mathbb{R}^{n \times m}, B \in \mathbb{R}^{p \times r}$, dann definieren wir 
%
\begin{align*}
A \otimes B =
\begin{pmatrix}
A_{11} B 	& \cdots 	& A_{1m} B 	\\
A_{12} B 	& \hdots 	& A_{2m} B	\\
\vdots		& \ddots	& \vdots	\\
A_{n1} B	& \cdots	& A_{nm} B
\end{pmatrix}
\in 
\mathbb{R}^{mp \times nr}
\end{align*}
\end{definition}
%----------------------------------------------------------------------------

Es gilt die Formel
%
\begin{align*}
\textsf{vec}(MXN) = (N^T \otimes M) \textsf{vec}(X)  
\end{align*}

Betrachten wir den Fall $M= 1$ und $N=A$ bzw. $N = 1$ und $M=A^T$ erhalten wir mit $X=K$ 
%
\begin{align*}
\textsf{vec}(KA)= (A^T \otimes 1) \textsf{vec}(K) \quad \textsf{vec}(A^T K) = (1 \otimes A^T) \textsf{vec}(K)
\end{align*}

Anwendung auf unser Problem liefert
%
\begin{align*}
\underbrace{\textsf{vec}(F(K))}_{f(x = \textsf{vec}(K))} = \underbrace{\textsf{vec}(Q)}_{q} - \underbrace{\textsf{vec}(KPK)}_{g(x = \textsf{vec}(K))} + \underbrace{\textsf{vec}(KA)}_{(A^T \otimes 1) \textsf{vec}(K)} + \underbrace{\textsf{vec}(A^T K)}_{(1 \otimes A^T) \textsf{vec}(K)}
\end{align*}

Durch Einführung von $x = \textsf{vec}(K) \in \mathbb{R}^{n^2}$ erhalten wir 
%
\begin{align*}
f(x) = q - g(x)+ (A^T \otimes 1)x + (1 \otimes A^T)x
\end{align*}

Da $(KP)^T = KP$ gilt 
% 
\begin{align*}
g(\textsf{vec}(K)) = \textsf{vec}(KPK) = (1 \otimes KP) \textsf{vec}(K) 
\end{align*}

% Hier arbeit 14.07
%-----------------------------------------------------------------------------------

Wir betrachten die Variation $K(\epsilon) = K + \epsilon \cdot \bar{K}$ und die Funktion $h:\mathbb{R} \to \mathbb{R}^{n^2}$ mit
%
\begin{align*}
h(\epsilon) 
:= g(\textsf{vec}(K(\epsilon))) 
&= \textsf{vec}(K(\epsilon) P K(\epsilon)) \\
&= \textsf{vec}((K + \epsilon \cdot \bar{K}) P (K + \epsilon \cdot \bar{K})) \\
&= \textsf{vec}(KPK + \epsilon KP \bar{K} + \epsilon \bar{K} PK + \epsilon^2 \bar{K} P \bar{K})
\end{align*}

Ableitung nach $\epsilon$ und Auswertung in $\epsilon = 0$ ergibt
%
\begin{align*}
h'(0) = \frac{d}{d\epsilon} g(\textsf{vec}(K + \epsilon \bar{K})) \bigg|_{\epsilon = 0} = \textsf{vec}(KP\bar{K} + \bar{K}PK)
= \textsf{vec}(KP\bar{K}) + \textsf{vec}(\bar{K}PK)
\end{align*}

Umschreiben als Matrix-Vektor-Produkt
%
\begin{align*}
\textsf{vec}(KP \cdot \bar{K} \cdot 1) = (1 \otimes KP) \textsf{vec}(\bar{K}) \quad \textsf{vec}(1 \cdot \bar{K} \cdot PK) = ((PK)^T \otimes 1) \textsf{vec}(\bar{K})
\end{align*}

Wir erhalten als Ableitung 
%
\begin{align*}
g'(x) = (1 \otimes KP) + ((PK)^T \otimes 1) \Rightarrow f'(x) = - (1 \otimes KP) - ((PK)^T \otimes 1) + (A^T \otimes 1) + (1 \otimes A^T)
\end{align*}

\subsubsection{Implementierung}

\begin{minipage}{0.65\textwidth}
\begin{lstlisting}
def vec(X):
    return X.reshape(-1, order='F')

def unvec(v, n):
    return v.reshape((n, n), order='F')
\end{lstlisting}
\end{minipage}
%
\begin{minipage}{0.35\textwidth}
Hier normaler text
\end{minipage}

\begin{minipage}{0.65\textwidth}
\begin{lstlisting}
# Newton Kleinman Verfahren 
def solv_CARE(A,B,R,Q,tol=1e-8,max_iter=50):
	n = A.shape[0]
	I = np.eye(n)
	q = vec(Q)
	L = np.kron(I, A.T) + np.kron(A.T, I)
	P = B @ np.linalg.solve(R, B.T)
	# Startwert K0 hier Einheitsmatrix
	K = I
	x = vec(K)	
	
	for i in range(max_iter):
		X = K @ P #KP
		vec_KPK = np.kron(I,X) @ x
		f = q - vec_KPK + L @ x 
		Dg = np.kron(I,X)+np.kron(X,I) 
		Df = L - Dg
		dx = np.linalg.solve(Df, -f)
		x_new = x + dx
		# Abbruch
		if np.linalg.norm(dx) / np.linalg.norm(x_new) < tol:
			x=x_new
			break
        
        x = x_new
        K = unvec(x, n)
	return K
\end{lstlisting}
\end{minipage}
%
\begin{minipage}{0.35\textwidth}
\rot{Erklärung des Codes}

\blau{Stabilität der Startlösung hier Gershgorin kreise und Stabilität erklären}

Für $Y$ mit $RY=B^T \Rightarrow Y = B^{-1}B^T$ und $B \cdot Y = P$
\end{minipage}
%




%-----------------------------------------------------------------------------------
\newpage
\section{Linearisierung der Dynamik}

% Arbeitsbereich
Wir definieren den Zustand 
$\textbf{x} = 
\begin{bmatrix}
    \textbf{q} \\ \dot{\textbf{q}}
\end{bmatrix}$
und schreiben unsere Dynamikgleichung wir folgt um 
% Linearisierung der allgemeinen Dynamik x = [q; q']
\begin{align*}
    M(\textbf{q}) \ddot{\textbf{q}} 
    + C(\textbf{q}, \dot{\textbf{q}}) \dot{\textbf{q}} 
    + G(\textbf{q}) = \bm{u} 
    \Rightarrow
    \underbrace{
            \begin{bmatrix}
                \dot{\textbf{q}} \\ \ddot{\textbf{q}}
            \end{bmatrix}
    }_{
        \dot{\textbf{x}}
    }
    =
    \underbrace{
        \begin{bmatrix}
            \dot{\textbf{q}} \\
            M^{-1}(\textbf{q}) 
            \left[ 
                \bm{u} - C(\textbf{q}, \dot{\textbf{q}}) \dot{\textbf{q}} - G(\textbf{q}) 
                \right]
        \end{bmatrix}
    }_{
        f(\textbf{x}, \bm{u})
    }
\end{align*}

\subsection{Linearisierung des two link revolute manipulators}

Wir definieren  $x_1 = q_1$, $x_2 = q_2$, $x_3 = \dot{q_1}$, $x_4 = \dot{q_2}$  
und erhalten $\dot{\bm{x}} = f(\bm{x},\bm{u})$ mit
% Hier f genau definieren
\begin{align*}
    \begin{bmatrix}
        f_1(\bm{x},\bm{u})  \\
        f_2(\bm{x},\bm{u}) 
    \end{bmatrix} 
    =
    \begin{bmatrix}
        x_3 \\
        x_4
    \end{bmatrix}
    \quad
    \begin{bmatrix}
        f_3(\bm{x},\bm{u}) \\
        f_4(\bm{x},\bm{u}) 
    \end{bmatrix}
    =
    M(x_1,x_2)^{-1}
    \left[ 
        \bm{u} - C(\bm{x}) 
        \begin{pmatrix} 
            x_3 \\ 
            x_4  
        \end{pmatrix}  
        - G(x_1, x_2) 
    \right]
\end{align*}

Wir linearisieren um den Arbeitspunkt $(\bm{x}^*, \bm{u}^*)$
% Linearisierung x' = f(x,u) approx f(x*,u*) + df/dx (x-x*) + df/du (u-u*)
\begin{align*}
    \dot{\bm{x}} 
    &= f(\bm{x},\bm{u}) \\
    &\approx \underbrace{f(\bm{x}^*,\bm{u}^*)}_{= 0} + 
    \underbrace{\frac{\partial f}{\partial x}(\bm{x}^*,\bm{u}^*)}_{A(\bm{x}^*,\bm{u}^*)}(\bm{x}-\bm{x}^*) 
    + \underbrace{\frac{\partial f}{\partial u}(\bm{x}^*,\bm{u}^*)}_{B(\bm{x}^*,\bm{u}^*)}(\bm{u}-\bm{u}^*) 
    \\
    &= A(\bm{x}^*,\bm{u}^*) \bar{\bm{x}} + B(\bm{x}^*,\bm{u}^*) \bar{\bm{u}}
\end{align*}

Wobei $\bar{\bm{x}}(t) = \bm{x}(t) -\bm{x}^*$ und $\bar{\bm{u}}(t) = \bm{u}(t)-\bm{u}^*$ gilt. 
Für die Ableitung der Größen gilt
% Ableitung der Abweichung
\begin{align*}
    \frac{\mathrm{d} \bar{\bm{x}}}{\dt}
    = \dot{\bm{x}} - \underbrace{\frac{\mathrm{d} \bm{x}^*}{\dt}}_{= 0} 
    = \dot{\bm{x}}(t) 
    \Rightarrow 
    \bar{\bm{x}}(t) = A \bar{\bm{x}}(t) + B \bar{\bm{u}}(t)
\end{align*}

Aus der Produktregel folgt für die Ableitung
% D(M q'') = DM q'' + M D(q'') = Dh
\begin{align*}
    \frac{\partial}{\partial \bm{x}} 
    \left[ 
        \vphantom{\int}
        M(x_1,x_2) \ddot{\bm{q}}
    \right] 
    &= 
    \frac{\partial}{\partial \bm{x}} 
    \left[
    \underbrace{
        \bm{u} - C(\bm{x}) 
        \begin{pmatrix}
            x_3 \\
            x_4
        \end{pmatrix} 
        - G(x_1,x_2)
        }_{
            := h(\bm{x}, \bm{u})
            }  
    \right]
    \Rightarrow
    \frac{\partial M}{\partial \bm{x}} \ddot{\bm{q}} 
    + M(\bm{q}) \frac{\partial \ddot{\bm{q}}}{\partial \bm{x}} 
    = 
    \frac{\partial h}{\partial \bm{x}}
\end{align*}

Am Arbeitspunkt $(\bm{x}^*, \bm{u}^*)$ gilt $\ddot{\bm{q}} = \bm{0}$ 
und somit folgt für die Ableitung von $h$ in $(\bm{x}^*, \bm{u}^*)$:
% Am Gleichgewichtspunkt q'' = 0
\begin{align*}
    \frac{\partial h}{\partial \bm{x}}(\bm{x}^*, \bm{u}^*)
    &=
    \underbrace{
        \frac{\partial M}{\partial \bm{x}} \ddot{\bm{q}} 
        }_{=0}
    + M(\bm{x}^*) \frac{\partial \ddot{\bm{q}}}{\partial \bm{x}}  
    \Rightarrow
    \frac{\partial \ddot{\bm{q}}}{\partial \bm{x}} 
    = 
    M^{-1}(\bm{x}^*) \frac{\partial h}{\partial \bm{x}}(\bm{x}^*, \bm{u}^*)
\end{align*}

% Hier konkrete Ableitungen der Dynamik um A unf B zu erhalten. 
% Dazu müssen wir die konkreten Dynamik in jeder Komponente aufschreiben.
%----------------------------------------------------------------------------------------------

\begin{align*}
    \begin{pmatrix}
        m_1 a_1^2 + I_1 + m_2 \cdot (l_1^2 +a_2^2 + 2 l_1 a_2  \cos(\dunkelrot{x_{2}}) ) + I_2 
        &  m_2 \cdot (a_2^2 +  l_1 a_2  \cos(\dunkelrot{x_{2}})) + I_2 \\
        m_2 \cdot (a_2^2 +  l_1 a_2  \cos(\dunkelrot{x_{2}})) + I_2	
        & m_2 a_2^2 + I_2
    \end{pmatrix}
    \cdot
    \begin{pmatrix}
        \gruen{x_3}' \\
        \dunkelrot{x_4}'
    \end{pmatrix}
\end{align*}

\begin{align*}
    C \cdot \theta'(t)
    &=
    \begin{pmatrix}
        -2m_2 l_1 a_2 \sin(\dunkelrot{x_2}) \dunkelrot{x_4} 
        &
        - m_2 l_1 a_2 \sin(\dunkelrot{x_2}) \dunkelrot{x_4} 
        \\
        m_2 l_1 a_2 \sin(\dunkelrot{x_2})\gruen{x_3}
        &
        0
    \end{pmatrix}
    \begin{pmatrix}
        \gruen{x_3} \\
        \dunkelrot{x_4} 
    \end{pmatrix}
    \\
    &= 
    \begin{pmatrix}
        -2m_2 l_1 a_2 \sin(\dunkelrot{x_2}) \dunkelrot{x_4} \gruen{x_3} 
        - m_2 l_1 a_2 \sin(\dunkelrot{x_2}) \dunkelrot{x_4}^2 \\
        m_2 l_1 a_2 \sin(\dunkelrot{x_2})\gruen{x_3}^2
    \end{pmatrix}
\end{align*}


\begin{align*}
    G(x_1,x_2) &=
    \begin{pmatrix}
        m_1  g  a_1 \cos(\gruen{x_1}) + m_2  g \left( l_1 \cos(\gruen{x_1}) 
        + a_2 \cos(\gruen{x_1} + \dunkelrot{x_2}) \right) \\
        m_2  g \left( l_1 \cos(\gruen{x_1}) + a_2 \cos(\gruen{x_1} 
        + \dunkelrot{x_2}) \right)
    \end{pmatrix}
\end{align*}




Für die Inverse der Massenmatrix gilt analytisch 
mittels $F_{\dunkelrot{x_2}} := m_2 l_1 a_2 \cos(\dunkelrot{x_{2}})$

\begin{align*}
    \det(M) &= M_{11} M_{22} - M_{12}^2 \\
            &= \left[ m_1 a_1^2 + I_1 + m_2 \cdot (l_1^2 +a_2^2 + 2 l_1 a_2  
            \cos(\dunkelrot{x_{2}}) ) + I_2 \right]
             \cdot (m_2 a_2^2 + I_2) \\
            &\quad - (m_2 \cdot (a_2^2 +  l_1 a_2  \cos(\dunkelrot{x_{2}})) + I_2)^2 \\
            &= 
            \left[
            m_1 a_1^2 + I_1 + I_2 + m_2 l_1^2 +m_2 a_2^2 + 
            2 \underbrace{m_2 l_1 a_2  
            \cos(\dunkelrot{x_{2}})}_{F_{\dunkelrot{x_2}}} 
            \right] 
            (m_2 a_2^2 + I_2) \\ 
            &\quad
            - (m_2 a_2^2 + I_2)^2
            - 2 \underbrace{m_2 l_1 a_2 \cos(\dunkelrot{x_{2}})}_{F_{\dunkelrot{x_2}}}
            \cdot (m_2 a_2^2 + I_2)
            - F_{\dunkelrot{x_2}}^2 \\
            &= 
            (m_2 a_2^2 + I_2) \cdot 
            \left[
                m_1 a_1^2 + I_1 + m_2 l_1^2 +
                \underbrace{I_2  + m_2 a_2^2 - m_2 a_2^2 - I_2}_{= 0}
            \right]
            - \underbrace{
                (m_2 l_1 a_2 )^2 (1- \sin(\dunkelrot{x_2})^2)
                }_{F_{\dunkelrot{x_2}}^2}
            \\
            &= 
            (m_2 a_2^2 + I_2) \cdot (m_1 a_1^2 + I_1 + m_2 l_1^2)
            - (m_2 l_1 a_2 )^2 + (m_2 l_1 a_2 )^2 \sin(\dunkelrot{x_2})^2
            \\
            &= (m_2 a_2^2 + I_2) \cdot (m_1 a_1^2 + I_1) 
            + \underbrace{
                (m_2 a_2^2 + I_2) \cdot m_2 l_1^2
            }_{m_2^2 l_1^2 a_2^2+ m_2 l_1^2 I_2}
            - (m_2 l_1 a_2 )^2 + (m_2 l_1 a_2 )^2 \sin(\dunkelrot{x_2})^2
            \\
            &= (m_1 a_1^2 + I_1 + m_2 l_1^2)
            \cdot (m_2 a_2^2 + I_2) 
            + m_2 l_1^2 I_2
            + m_2^2 l_1^2 a_2^2  \sin(\dunkelrot{x_2})^2
\end{align*}

Für die Inverse der Massenmatrix gilt somit
\begin{align*}
    M^{-1} &= \frac{1}{\det(M)} 
    \begin{pmatrix}
        M_{22} & -M_{12} \\
        -M_{21} & M_{11}
    \end{pmatrix} \\
    &= \frac{1}{\det(M)} 
    \begin{pmatrix}
        m_2 a_2^2 + I_2 & - (m_2 \cdot (a_2^2 +  l_1 a_2  \cos(\dunkelrot{x_{2}})) + I_2) \\
        - (m_2 \cdot (a_2^2 +  l_1 a_2  \cos(\dunkelrot{x_{2}})) + I_2) & m_1 a_1^2 + I_1 + m_2 \cdot (l_1^2 +a_2^2 + 2 l_1 a_2  \cos(\dunkelrot{x_{2}}) ) + I_2 
    \end{pmatrix}
\end{align*}

\begin{align*}
    M_{11} &= m_1 a_1^2 + I_1 + m_2 \cdot (l_1^2 +a_2^2 + 2 l_1 a_2  \cos(\dunkelrot{x_{2}}) ) + I_2 \\
    M_{12} &= m_2 \cdot (a_2^2 +  l_1 a_2  \cos(\dunkelrot{x_{2}})) + I_2 \\
    M_{21} &= M_{12} \\
    M_{22} &= m_2 a_2^2 + I_2
\end{align*}
%----------------------------------------------------------------------------------------------


\begin{satz}
    Die Lösung des optimalen Steuerungsproblem:
    \begin{align*}
        \min_u \int_0^{\infty} x^T Q x + u^T R u \dt 
        \quad 
        \dot{x} = 
        \underbrace{\begin{pmatrix} 0 & I \\ 0 & 0 \end{pmatrix}}_{A} x 
        + \underbrace{\begin{pmatrix} 0 \\ I \end{pmatrix}}_{B} u
    \end{align*}
    ist gegeben durch
    %
    \begin{align*}
        u^{*} = -R^{-1} B^T K x  \quad \text{mit} \quad Q - KPK + KA + A^T K = 0
    \end{align*}

    und für die Momente gilt 
    %
    \begin{align*}
        \tau^{*} = M_0(q) u^{*} + N_0(q, \dot{q}) = -M_0(q) R^{-1} B^T K x + N_0(q, \dot{q})
    \end{align*}
\end{satz}


\usetikzlibrary{positioning}
\begin{tikzpicture}[>=latex]
    \node[draw= boxframe,anchor = north west ,align=left] (a) at (-2,0) {
        Ursprungsproblem:\\
        $\begin{aligned}
            \min_u & \int_0^\infty q^T Q q + \tau^T R \tau \\
            	ext{s.t. } & M(q) \ddot{q} + C(q,\dot{q}) \dot{q} + G(q) = \tau;
        \end{aligned}$
    };
    \node[draw = rot, anchor = north west, align=left] (b) at ([xshift=1cm]a.north east) {
        LQR:\\
        %1. Wahl von Nominaltermen $M_0, C_0, G_0$\\
        $\begin{aligned}
            \min_u \int_0^{\infty} x^T Q x + u^T R u \dt 
            \quad 
            \dot{x} = 
            \underbrace{\begin{pmatrix} 0 & I_2 \\ 0 & 0 \end{pmatrix}}_{A} x 
            + \underbrace{\begin{pmatrix} 0 \\ I_2 \end{pmatrix}}_{B} u
        \end{aligned}$
    };
    \node[draw = rot, below=of b, align=center] (c) {
        Lösung der CARE für $n=2$ \\
        $\begin{aligned}
            Q - K \underbrace{B R^{-1} B^T}_{P} K + KA + A^T K &= 0 
        \end{aligned}$
        };
    \node[draw = rot, below=of c, align=center] (d) {Closed-Loop Regelung:\\
        $\begin{aligned}
            u^{*} = -R^{-1} B^T K x
        \end{aligned}$
        };
    \node[draw = boxframe, anchor=south, align=left] (e) at ([yshift=-6cm]a.south) {
        Lösung Originalsystem \\
        $\begin{aligned}
            \tau^{*} &= M_0(q) u^{*} + N_0(q, \dot{q}) \\
            M_0 &= M(q=0)  \\
            N_0 &= N(q, \dot{q}) = C_0(q, \dot{q}) \dot{q} + G_0(q)
        \end{aligned}$
        };

    \draw[->, color = boxframe] (a) -- (b);
    \draw[->, color = boxframe] (b) -- (c);
    \draw[->, color = boxframe] (c) -- (d);
    \draw[->, color = boxframe] (d.west) -- ++(-3.65cm,0cm);
    \draw[->, color = gruen] (a) -- (e);
\end{tikzpicture}

\proof{
    Für die Value Funktion erhalten wir 
    %
    \begin{align*}
        \frac{\mathrm{d}}{\dt} V(x(t)) &= 
        \underbrace{\nabla V(x)}_{2K x(t)} 
        \cdot 
        \underbrace{x'(t)}_{Ax(t) + Bu(t)} \\
        &= 2 x(t)^T K 
        \left[ 
            Ax(t) + B \underbrace{ - R^{-1} B^T K x(t)}_{u(t)} 
        \right] \\
        &= x(t)^T 
        \left[ 
            \underbrace{K A + A^T K - 2 K B R^{-1} B^T K}_{-Q - K B R^{-1} B^T K} 
        \right] 
        x(t) \\
        &= - x(t)^T Q x(t) - \underbrace{x(t)^T K B}_{x(t)^T K B R^{-1} R} \underbrace{R^{-1} B^T K x(t)}_{-u^*(t)} \\
        &= - x(t)^T Q x(t) - \underbrace{x(t)^T K B R^{-1} R}_{u^{*}(t)^T R} u^*(t) \\
        &= - x(t)^T Q x(t) - u^{*}(t)^T R u^{*}(t)
    \end{align*}

    Wir erhalten somit $\frac{\mathrm{d}}{\dt} V(x(t)) \leq 0$ mit Gleichheit genau dann wenn $x(t) = u^{*}(t) = 0$. 
    Damit ist die Value Funktion $V(x(t))$ streng monoton fallend und 
    somit ist das optimale Steuerungssignal $u^{*}(t)$ stabil.

    Verwenden wir die Value Funktion auf die reale Dynamik, so gilt

    \begin{align*}
        \frac{\mathrm{d}}{\dt} V(x(t)) 
        &= \nabla V(x) \cdot x'(t) \\
        &= 2 x(t)^T K 
        \left[ 
            Ax(t) + B u^{*}(t) + \begin{pmatrix} 0 \\ h(x(t)) u^{*}(t) + f(x(t)) \end{pmatrix}
        \right] \\
        &= 2 x(t)^T K 
        \left[ 
            Ax(t) + B u^{*}(t) + B h(x(t)) u^{*}(t) + B f(x(t))
        \right] \\
        &= \underbrace{ 2 x(t)^T K (Ax+Bu^{*})}_{(1)} + \underbrace{2 x(t)^T K B (h(x) u^{*} + f(x))}_{(2)}
    \end{align*}

    wobei wir $B = \begin{pmatrix} 0 \\ I_2 \end{pmatrix}$ verwendet haben. 
    Aus $u^* = -R^{-1} B^T K x(t)$ folgt $B^T K x(t) = -R u^{*}$ und wir erhalten für $(2)$

    \begin{align*}
        2 x(t)^T K B (h(x) u^{*} + f(x)) 
        &= 2 \left[\underbrace{B^T K x(t)}_{-R u^{*}} \right]^T (h(x) u^{*} + f(x)) \\
        &= -2 (u^{*})^T R (h(x) u^{*} + f(x)) \\
        &= -2 (u^{*})^T R h(x) u^{*} - 2 (u^{*})^T R f(x)
    \end{align*}

    Für $h$ positiv definit gilt:
    \begin{align*}
        -(u^{*})^T R h(x) u^{*} \leq 0
    \end{align*}

    Für jedes $\epsilon > 0$ gilt:
    \begin{align*}
        -2 (u^{*})^T R f(x) 
        &\leq 2 \|u^{*}\| \|R\| \|f(x)\| \\
        &\leq \epsilon \|u^{*}\|^2 + \frac{1}{\epsilon} \|R\|^2 \|f(x)\|^2 \\
        &= \epsilon (u^{*})^T u^{*} + \frac{1}{\epsilon} \|R\|^2 \|f(x)\|^2 \\
        &\leq \epsilon (u^{*})^T R u^{*} + \frac{1}{\epsilon} \|R\|^2 \|f(x)\|^2
    \end{align*}

    Wir wählen als Schranke $f^T R f \leq x^T P x$
}

\subsection{Beispiel von Lin}

\begin{align*}
    & m_1 = 13.86 \approx \mathrm{oz}, \quad m_2 = 3.33 \approx \mathrm{oz}, \\
& r_1 = 6.12 \approx \mathrm{in}, \quad r_2 = 3.22 \approx \mathrm{in}, \\
& l_1 = 8 \approx \mathrm{in}, \quad l_2 = 6 \approx \mathrm{in}, \\
& J_1 = 62.39 \approx \mathrm{oz\cdot in/rad/s^2}, 
\quad J_2 = 16.70 \approx \mathrm{oz\cdot in/rad/s^2}, \\
& m_L = 10\,\varepsilon \approx \mathrm{oz}, \quad J_L = 60\,\varepsilon^2 \approx \mathrm{oz\cdot in/rad/s^2}, \quad \varepsilon=1.
\end{align*}

Umrechnung in SI 

\begin{align*}
    1\mathrm{oz} = 0.0283495\mathrm{kg}, \quad
    1\mathrm{in} = 0.0254\mathrm{m}, \quad
    1\mathrm{oz\cdot in/rad/s^2} = 7.06155\times 10^{-3}\mathrm{kg\cdot m^2}.
\end{align*}

\begin{align*}
    & m_1 = 13.86\cdot 0.0283495 \approx 0.3929~\mathrm{kg}, \qquad
    m_2 = 3.33\cdot 0.0283495 \approx 0.0944~\mathrm{kg}, \\
    & r_1 = 6.12\cdot 0.0254 \approx 0.1554~\mathrm{m}, \qquad
    r_2 = 3.22\cdot 0.0254 \approx 0.0818~\mathrm{m}, \\
    & l_1 = 8\cdot 0.0254 = 0.2032~\mathrm{m}, \qquad
    l_2 = 6\cdot 0.0254 = 0.1524~\mathrm{m}, \\
    & J_1 = 62.39\cdot 7.06155\times 10^{-3} \approx 0.4400~\mathrm{kg\cdot m^2}, \\
    & J_2 = 16.70\cdot 7.06155\times 10^{-3} \approx 0.1181~\mathrm{kg\cdot m^2}, \\
    & m_L = 10\cdot 0.0283495 = 0.2835~\mathrm{kg}, \qquad
    J_L = 60\cdot 7.06155\times 10^{-3} \approx 0.4237~\mathrm{kg\cdot m^2}.
\end{align*}


% Formeln für a,b,c (2R-Planar mit Payload am Endeffektor)

\begin{align*}
    a &= J_1 + J_2 + m_1 r_1^2 + m_2\!\left(l_1^2 + r_2^2\right) + m_L\!\left(l_1^2 + l_2^2\right) + J_L,\\
b &= m_2\, l_1\, r_2 + m_L\, l_1\, l_2,\\
c &= J_2 + m_2 r_2^2 + m_L\, l_2^2 + J_L.
\end{align*}

% Numerische Werte für a,b,c in SI

\begin{align*}
    a &\approx 1.0145~\mathrm{kg\cdot m^2},\\
b &\approx 0.01035~\mathrm{kg\cdot m^2},\\
c &\approx 0.5488~\mathrm{kg\cdot m^2}.
\end{align*}


% Nominale Massmatrix M_0(q) in SI

\begin{align*}
    M_0(q) =
    \begin{pmatrix}
        a + 2b\,\cos q_2 & c + b\,\cos q_2 \\
        c + b\,\cos q_2 & c
    \end{pmatrix}
    =
    \begin{pmatrix}
        1.0145 + 2\cdot 0.01035\,\cos q_2 & 0.5488 + 0.01035\,\cos q_2 \\
        0.5488 + 0.01035\,\cos q_2 & 0.5488
    \end{pmatrix}
\end{align*}

% Vergleich in der "Papier"-Skalierung (ohne SI-Umrechnung der Summanden)
% (= direkte Einsetzung der imperialen Zahlen in die gleichen Formeln)

\begin{align*}
    a_{\text{paper}} &\approx 846.4 + 1000 + 60 \;=\; 1906.4,\\
    b_{\text{paper}} &\approx 85.6 + 480 \;=\; 565.6,\\
    c_{\text{paper}} &\approx 51.2 + 360 + 60 \;=\; 471.2.
\end{align*}


\begin{align*}
    M_0(q)\_{\text{paper}} \approx
    \begin{pmatrix}
        1906 + 2\cdot 565.6\,\cos q_2 & 471 + 565.6\,\cos q_2 \\
        471 + 565.6\,\cos q_2 & 471
    \end{pmatrix}
    =
    \begin{pmatrix}
        1906 + 1131.2\,\cos q_2 & 471 + 565.6\,\cos q_2 \\
        471 + 565.6\,\cos q_2 & 471
    \end{pmatrix}.
\end{align*}


% Abgleich mit der im Text zitierten Form und Hinweis auf Tippfehler

\begin{align*}
    \text{Im Text zitiert:}\quad
    M_0(q) =
    \begin{pmatrix}
        1906 + 1132\,\cos q_2 & 471 + \color{red}{86}\,\cos q_2 \\
        471 + \color{red}{86}\,\cos q_2 & 471
    \end{pmatrix}.
\end{align*}



\end{document}